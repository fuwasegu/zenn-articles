---
title: "Eloquent whereHas() ã¯ã‚‚ã†é…ããªã„ã‚ˆï¼"
emoji: "ðŸƒâ€â™‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Laravel", "PHP", "MySQL", "PostgreSQL", "Eloquent"]
published: false
---

:::message
æœ¬è¨˜äº‹ã§æ‰±ã† RDBMS ã¯ MySQL ã¨ PostgreSQL ã®ã¿ã§ã™ï¼Ž
:::

# ã¯ã˜ã‚ã«
Laravel Eloquent ã«ã¯ `whereHas()` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ï¼Žã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ï¼Œãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¤œç´¢æ¡ä»¶ã«å«ã‚ãŸã„æ™‚ã«æ´»ç”¨ã§ãã‚‹ã‚‚ã®ã§ã™ï¼Ž

ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼Ž

ä»Šï¼ŒAuthor ãƒ¢ãƒ‡ãƒ«ã¨ Book ãƒ¢ãƒ‡ãƒ«ãŒ hasMany ã®é–¢ä¿‚ï¼ˆ1ï¼šä»– ã®é–¢ä¿‚ï¼‰ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ï¼Ž

```php:Author.php
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\HasMany;

/**
 * @property int    $id   PK
 * @property string $name æ°å
 */
class Author extends Model
{
    public function books(): HasMany
    {
        return $this->hasMany(Book::class);
    }
}
```

```php:Book.php
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

/**
 * @property int             $id           PK
 * @property string          $title        ã‚¿ã‚¤ãƒˆãƒ«
 * @property int             $author_id    è‘—è€… ID
 * @property CarbonImmutable $published_at å‡ºç‰ˆæ—¥
 */
class Book extends Model
{
    public function author(): BelongsTo
    {
        return $this->belongsTo(Author::class);
    }
}
```

ã“ã®ã¨ãï¼Œå‡ºç‰ˆæ—¥ãŒ 2000-01-01 ä»¥é™ã®æ›¸ç±ã‚’æ›¸ã„ãŸã“ã¨ã®ã‚ã‚‹è‘—è€…ä¸€è¦§ã‚’å–å¾—ã—ãŸã„å ´åˆï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ï¼Ž

```php
use App\Models\Author;
use Carbon\Carbon;
use Illuminate\Contracts\Database\Query\Builder;

$users = Author::query()
    ->whereHas('books', function (Builder $query) {
        $query->where('published_at', '>', Carbon::parse('2000-01-01'));
    })
    ->get();
```

ã“ã®ã‚ˆã†ã«ï¼Œ`whereHas()` ã‚’ä½¿ã†ã“ã¨ã§ï¼Œå¯¾è±¡ã®ãƒ¢ãƒ‡ãƒ«ã«ç´ã¥ãåˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦æ¡ä»¶ã‚’ä»˜ä¸Žã—ã¦æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼Ž

ä»Šå›žã¯ï¼Œã“ã® `whereHas()` ã®ãŠè©±ã§ã™ï¼Ž

# é…ã„ã¨è¨€ã‚ã‚ŒãŸ whereHas()
ã•ã¦ï¼Œ`whereHas()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã“ã®ã‚ˆã†ã«éžå¸¸ã«ä¾¿åˆ©ãªãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ãŒï¼Œã“ã‚Œã¾ã§ã¯å‰²ã¨é¿ã‘ã‚‰ã‚ŒãŒã¡ãªãƒ¡ã‚½ãƒƒãƒ‰ã§ã—ãŸï¼Ž

æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ [Laravel whereHas] ã¨æ¤œç´¢ã™ã‚‹ã¨ï¼Œã€ŒwhereHas ã¯é‡ã„ãƒ»é…ã„ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªè¨˜äº‹ãŒå‰²ã¨å‡ºã¦ãã¾ã™ï¼Ž

é…ã„ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ç†ç”±ã«ã¤ã„ã¦ã¯ï¼Œæ—¢ã«ã„ã‚ã‚“ãªè¨˜äº‹ã¨ã—ã¦ä¸–ã«å‡ºã¦ã„ã‚‹ãŸã‚è©³ã—ãã¯å‰²æ„›ã—ã¾ã™ãŒï¼Œç°¡å˜ã«è¨€ã†ã¨ `whereHas()` ã‚’ä½¿ã£ãŸã¨ãã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãŒåãã‚¯ã‚¨ãƒªãŒ **ç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒª** ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ï¼Ž

å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã‚’ãƒ€ãƒ³ãƒ—ã—ã¦ã¿ã‚‹ã¨ï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼ˆæ•´å½¢æ¸ˆã¿ï¼‰ï¼Ž

```sql
SELECT *
FROM "authors"
WHERE EXISTS (
    SELECT *
    FROM "books"
    WHERE "authors"."id" = "books"."author_id"
        AND "published_at" > '2022-01-01 00:00:00'
);
```

ã‚¯ã‚¨ãƒªã‚’è¦‹ã‚‹ã¨ï¼Œ`WHERE "authors"."id" = "books"."author_id"` ã®éƒ¨åˆ†ãŒç›¸é–¢ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼Ž`authors` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€è¡Œæ¯Žã«ï¼Œwhere å¥ã®ä¸­ã®ã‚µãƒ–ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šï¼Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒè½ã¡ã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ï¼Ž

# ãã‚‚ãã‚‚ PostgreSQL ã§ã¯é…ããªã‹ã£ãŸ
å®Ÿã¯ï¼Œã“ã®å•é¡ŒãŒèµ·ã“ã‚‹ã®ã¯ MySQL ã®ã¿ã§ï¼ŒPostgreSQL ã®å ´åˆã¯é…ããªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼Žãªãœãªã‚‰ï¼ŒPostgreSQL ã§ã¯ã‚ªãƒ—ãƒ†ã‚£ãƒžã‚¤ã‚¶ãŒã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–ã—ã¦ãã‚Œã‚‹ãŸã‚ã§ã™ï¼Ž

å®Ÿéš›ã« PostgreSQL ã§ã¯ã©ã®ã‚ˆã†ãªå®Ÿè¡Œè¨ˆç”»ã«ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Œ`EXPLAIN` æ–‡ã‚’ä½¿ã£ã¦è¦—ã„ã¦ã¿ã¾ã™ï¼Ž

```sql:å®Ÿè¡Œè¨ˆç”»(PostgreSQL 14.4)
explain select * from "authors" where exists (select * from "books" where "authors"."id" = "books"."author_id" and "published_at" > '2022-01-01 00:00:00');

                                           QUERY PLAN
-------------------------------------------------------------------------------------------------
 Hash Join  (cost=28.25..58.26 rows=357 width=36)
   Hash Cond: (authors.id = books.author_id)
   ->  Seq Scan on authors  (cost=0.00..22.70 rows=1270 width=36)
   ->  Hash  (cost=26.04..26.04 rows=177 width=4)
         ->  HashAggregate  (cost=24.27..26.04 rows=177 width=4)
               Group Key: books.author_id
               ->  Seq Scan on books  (cost=0.00..23.38 rows=357 width=4)
                     Filter: (published_at > '2022-01-01 00:00:00'::timestamp without time zone)
```

PostgreSQL ã®å®Ÿè¡Œè¨ˆç”»ã¯æœ¨æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ï¼Žä¸Šè¨˜ã®å®Ÿè¡Œè¨ˆç”»ã‚’ç°¡å˜ã«æ¨¹å½¢å›³ã«æ›¸ãèµ·ã“ã™ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼Žï¼ˆå…ˆé ­ã®æ•°å­—ã¯å®Ÿè¡Œé †ï¼‰

:::message
PostgreSQL ã®å®Ÿè¡Œè¨ˆç”»ã¯ï¼Œæ¬¡ã®ã‚ˆã†ãªãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦é †ç•ªã«å®Ÿè¡Œã•ã‚Œã¾ã™ï¼Ž
* ãƒã‚¹ãƒˆãŒæ·±ã„ã¨ã“ã‚ã‹ã‚‰å®Ÿè¡Œã—ã¦ã„ã
* å…„å¼Ÿè¦ç´ ãŒã‚ã‚‹å ´åˆï¼Œå…ˆã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹æ–¹ã‚’å„ªå…ˆã™ã‚‹

è¦ç´„ã™ã‚‹ã¨ï¼Œè‘‰ãŒä¸¦ã‚“ã§ã„ãŸå ´åˆå…ˆã«æ›¸ã‹ã‚ŒãŸè‘‰ãŒå„ªå…ˆã•ã‚Œã‚‹æ·±ã•å„ªå…ˆæŽ¢ç´¢ï¼ˆDFSï¼‰ã¨è¨€ãˆã¾ã™ï¼Ž
:::

```mermaid
graph TD

A["â‘¤ Hash Join (1, 2è¡Œç›®)"]
B["â‘  Seq Scan (3è¡Œç›®)"]
C["â‘£ Hash (4è¡Œç›®)"]
D["â‘¢ HashAggregate (5è¡Œç›®)"]
E["â‘¡ Seq Scan (7è¡Œç›®)"]

A --> B
A --> C

C --> D

D --> E
```

ä»Šå›žã¯ï¼Œ`Seq Scan`, `HashAggregate`, `Hash`, `Hash Join` ã®4ç¨®é¡žã®æ¼”ç®—å­ãŒå‡ºã¦ãã¾ã—ãŸï¼Ž
ãã‚Œãžã‚Œã®æ„å‘³ã‚’ç°¡å˜ã«è§£èª¬ã—ã¾ã™ï¼Ž

### Seq Scan æ¼”ç®—å­
* å˜ç´”ã«è¡¨ã‚’é ­ã‹ã‚‰é †ç•ªã«è¦‹ã¦ã„ãï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ï¼‰
* æ¡ä»¶ã«é–¢ã‚ã‚‰ãšå„è¡Œã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹

### HashAggregate æ¼”ç®—å­
* GROUP BY ã®é«˜é€Ÿå‡¦ç†ãƒ«ãƒ¼ãƒãƒ³
* ãƒãƒƒã‚·ãƒ¥è¡¨ã‚’ä½¿ã£ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã™ã‚‹
* å¿…è¦ã¨ã™ã‚‹ãƒ¡ãƒ¢ãƒªãŒæ¯”è¼ƒçš„å¤šã‚

### Hash ã¨ Hash Join  æ¼”ç®—å­
* Hash ã¨ Hash Join ã¯ã‚»ãƒƒãƒˆã§å‡ºã¦ãã‚‹
* Hash ã¯ï¼ŒHash Join æ¼”ç®—å­ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒãƒƒã‚·ãƒ¥è¡¨ã‚’ä½œæˆã™ã‚‹
* å†…å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒƒã‚·ãƒ¥è¡¨ã‚’ä½œæˆã—ï¼Œå¤–å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒãƒƒã‚·ãƒ¥è¡¨ã‚’çªãåˆã‚ã›ã¦ãƒ†ãƒ¼ãƒ–ãƒ«åŒå£«ã‚’çµåˆã™ã‚‹


ä»¥ä¸Šã‚’è¸ã¾ãˆã¦ï¼Œå®Ÿéš›ã« PostgreSQL ãŒã©ã®ã‚ˆã†ã«å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã‹ã‚’æ•´ç†ã™ã‚‹ã¨ï¼Œï¼ˆç•ªå·ã¯æ¨¹å½¢å›³ã¨å¯¾å¿œã—ã¦ã„ã‚‹ï¼‰
1. authors ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
2. books  ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¡ä»¶ä»˜ãã§ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
    * `published_at > '2022-01-01 00:00:00'::timestamp without time zone` ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã™ã‚‹
3. ä¸€æ™‚çš„ã«ãƒãƒƒã‚·ãƒ¥è¡¨ã‚’ä½œæˆã—ï¼Œbooks ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ `author_id` ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã™ã‚‹
4. 3 ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ãŸ books ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥è¡¨ã‚’ä½œæˆã™ã‚‹
5. 4 ã§ä½œæˆã—ãŸãƒãƒƒã‚·ãƒ¥è¡¨ã‹ã‚‰ã‚’ä½¿ã£ã¦ authors ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ books ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã™ã‚‹

ã“ã‚Œã‚’è¦‹ã¦ã‚‚ï¼Œã€Œè¡Œæ¯Žã«ã‚µãƒ–ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€ã¨ã„ã†å‡¦ç†ã¯èµ°ã£ã¦ã„ãªã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ï¼Ž

# MySQL ã ã¨ã©ã†ã‹ï¼Ÿ
çµè«–ã‹ã‚‰è¨€ã†ã¨ï¼Œ**MySQL 8.0.16 ã‹ã‚‰ç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–ãŒå…¥ã£ãŸ** ã®ã§ï¼Œãã‚Œä»¥é™ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚Œã°ï¼ŒPostgreSQL ã¨åŒæ§˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¯è½ã¡ã¾ã›ã‚“ï¼Ž

https://dev.mysql.com/doc/refman/8.0/ja/semijoins.html

ã¨ã¯ã„ãˆï¼Œã›ã£ã‹ã PostgreSQL ã®å®Ÿè¡Œè¨ˆç”»ã‚’è©³ã—ãè¦‹ãŸã®ã§ï¼ŒMySQL ã®æ–¹ã‚‚è¦—ã„ã¦è¦‹ã¾ã—ã‚‡ã†ï¼ˆå¤‰æ…‹ï¼‰.

:::message alert
MySQL ã®ã‚ªãƒ—ãƒ†ã‚£ãƒžã‚¤ã‚¶ã¯ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒé•ã†ã ã‘ã§ã‹ãªã‚Šé€²æ­©ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼Ž
ä»Šå›žã¯  MySQL 8.0.16 ã¨ 5.7.38 ã‚’ä½¿ç”¨ã—ã¾ã—ãŸãŒï¼Œç­†è€…ãŒå‚è€ƒã«ã—ãŸè³‡æ–™ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã¨å®Ÿéš›ã®æŒ™å‹•ã«å·®ç•°ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼Ž
:::

# MySQL 8.0.16 ä»¥å‰ã®å®Ÿè¡Œè¨ˆç”»
æ‰‹å…ƒã« MySQL 5.7.38 ã®ç’°å¢ƒã‚’ç”¨æ„ã§ããŸã®ã§ï¼Œã“ã¡ã‚‰ã§è©¦ã—ã¦ã¿ã¾ã™ï¼Ž
MySQL ã‚‚ PostgreSQL ã¨åŒæ§˜ï¼Œå®Ÿè¡Œè¨ˆç”»ã‚’è¦‹ã‚‹ã«ã¯ã‚¯ã‚¨ãƒªæ–‡ã®å‰ã« `EXPLAIN` ã‚’ãã£ã¤ã‘ã‚‹ã ã‘ã§ã™ï¼Ž

```sql:å®Ÿè¡Œè¨ˆç”»(MySQL 5.7.38)
explain select * from authors where exists (select * from books where authors.id = books.author_id and published_at > '2022-01-01 00:00:00');

+----+--------------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+-------------+
| id | select_type        | table   | partitions | type | possible_keys | key       | key_len | ref                | rows | filtered | Extra       |
+----+--------------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+-------------+
|  1 | PRIMARY            | authors | NULL       | ALL  | NULL          | NULL      | NULL    | NULL               |    1 |   100.00 | Using where |
|  2 | DEPENDENT SUBQUERY | books   | NULL       | ref  | author_id     | author_id | 4       | testing.authors.id |    1 |   100.00 | Using where |
+----+--------------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+-------------+
```

PostgreSQL ã®æ™‚ã¨ã¯å…¨ç„¶é›°å›²æ°—ã®é•ã†å®Ÿè¡Œè¨ˆç”»ã§ã™ã­ï¼Žå…ˆç¨‹ã¯æœ¨æ§‹é€ ã«ãªã£ã¦å‡ºã¦ãã¾ã—ãŸãŒï¼Œä»Šå›žã¯ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§å‡ºåŠ›ã•ã‚Œã¾ã—ãŸï¼ˆå†…éƒ¨çš„ã«ã¯ï¼ŒMySQL ã®å®Ÿè¡Œè¨ˆç”»ã‚‚æœ¨æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ï¼ˆå¾Œè¿°ï¼‰ï¼‰ï¼Ž
MySQL ã®å®Ÿè¡Œè¨ˆç”»ã®èª­ã¿æ–¹ã«ã¤ã„ã¦ã¯ï¼Œå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ï¼Œãã®ã¾ã¾å¼•ç”¨ã—ã¾ã™ï¼Ž

https://dev.mysql.com/doc/refman/5.6/ja/explain-output.html

### EXPLAIN å‡ºåŠ›ã‚«ãƒ©ãƒ 

| ã‚«ãƒ©ãƒ         | æ„å‘³                                           |
| ------------- | ---------------------------------------------- |
| id            | SELECT è­˜åˆ¥å­                                  |
| select_type   | SELECT åž‹                                      |
| table         | å‡ºåŠ›æ¥­ã®ãƒ†ãƒ¼ãƒ–ãƒ«                               |
| partitions    | ä¸€è‡´ã™ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³                         |
| type          | çµåˆåž‹                                         |
| possible_keys | é¸æŠžå¯èƒ½ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹                         |
| key           | å®Ÿéš›ã«é¸æŠžã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹                   |
| key_len       | é¸æŠžã•ã‚ŒãŸã‚­ãƒ¼ã®é•·ã•                           |
| ref           | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨æ¯”è¼ƒã•ã‚Œã‚‹ã‚«ãƒ©ãƒ                  |
| rows          | èª¿æŸ»ã•ã‚Œã‚‹è¡Œã®è¦‹ç©ã‚‚ã‚Š                         |
| filtered      | ãƒ†ãƒ¼ãƒ–ãƒ«æ¡ä»¶ã«ã‚ˆã£ã¦ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ã•ã‚Œã‚‹è¡Œã®å‰²åˆ |
| Extra         | è¿½åŠ æƒ…å ±                                       |

### select_typeï¼ˆä¸€éƒ¨æŠœç²‹ï¼‰

| select_type å€¤     | æ„å‘³                                                   |
| ------------------ | ------------------------------------------------------ |
| SIMPLE             | å˜ç´”ãª SELECT ï¼ˆUNION ã‚„ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ãªã„ï¼‰       |
| PRIMARY            | æœ€ã‚‚å¤–å´ã® SELECT                                      |
| DEPENDENT SUBQUERY | ã‚µãƒ–ã‚¯ã‚¨ãƒªå†…ã®æœ€åˆã® SELECT ã§ï¼Œå¤–å´ã®ã‚¯ã‚¨ãƒªã«ä¾å­˜ã™ã‚‹ |

### type (ä¸€éƒ¨æŠœç²‹)
| type å€¤ | æ„å‘³                                                                                    |
| ------- | --------------------------------------------------------------------------------------- |
| ALL     | ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³                                                                    |
| ref     | PRIMARY ã‚‚ã—ãã¯ UNIQUE ã§ã¯ãªã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã£ã¦ç­‰ä¾¡æ¤œç´¢ï¼ˆwhere key = valueï¼‰ã‚’è¡Œã† |


ã•ã¦ï¼Œä»¥ä¸Šã‚’è¸ã¾ãˆã¦å®Ÿè¡Œè¨ˆç”»ã‹ã‚‰å®Ÿéš›ã«è¡Œã‚ã‚Œã¦ã„ã‚‹å‡¦ç†ã‚’æ•´ç†ã—ã¦ã¿ã¾ã™ï¼Ž

å®Ÿè¡Œè¨ˆç”»ã® `id` ãŒãã®ã¾ã¾ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œé †åºã«ãªã‚‹ã®ã§ï¼Œã¾ãšã¯ `select_type` ãŒ `PRIMARY` ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼Ž
`type` ãŒ `ALL` ã«ãªã£ã¦ã„ã‚‹ã®ã§ï¼Œ`authors` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ï¼Ž

æ¬¡ã«ï¼Œ`select_type` ãŒ `DEPENDENT SUBQUERY` ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼Ž
`DEPENDENT SUBQUERY` ãŒï¼Œã¾ã•ã«ç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒªã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ï¼Œ `select_type` ã®èª¬æ˜Žã«ã‚‚ã‚ã£ãŸã¨ãŠã‚Šï¼Œå¤–å´ã®ã‚¯ã‚¨ãƒªã«ä¾å­˜ã—ã¦ã„ã‚‹ã‚µãƒ–ã‚¯ã‚¨ãƒªã§ã™ï¼Žä»Šå›žã§ã‚ã‚Œã°ï¼Œå¤–å´ã®ã‚¯ã‚¨ãƒªã¯ä¸€ã¤å‰ã«å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ `authors` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã§ã™ã­ï¼Ž

ã¾ãŸï¼Œå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ï¼ˆMySQL 5.7ï¼‰

> For DEPENDENT SUBQUERY, the subquery is re-evaluated only once for each set of different values of the variables from its outer context.

å¤–éƒ¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã®å¤‰æ•°ã®ç•°ãªã‚‹å€¤ã®å„ã‚»ãƒƒãƒˆæ¯Žã« 1 åº¦ã®ã¿è©•ä¾¡ã•ã‚Œã‚‹ã¨æ›¸ã„ã¦ã‚ã‚‹ãŸã‚ï¼Œå¤–å´ã®ã‚¯ã‚¨ãƒªã® SELECT çµæžœã®è¡Œã«å¯¾ã—ã¦è¡Œã‚ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼Ž
ä»Šå›žï¼Œ`authors` ã®ã‚¹ã‚­ãƒ£ãƒ³ã«ã¤ã„ã¦ç‰¹ã«æ¡ä»¶ã¯æŒ‡å®šã—ã¦ã„ãªã„ãŸã‚ï¼Œ`authors` ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ï¼Œã‚µãƒ–ã‚¯ã‚¨ãƒªãŒè©•ä¾¡ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼Ž

# MySQL 8.0.16 ä»¥é™ã®å®Ÿè¡Œè¨ˆç”»
ã§ã¯ï¼ŒMySQL 8.0.16 ä»¥é™ã®å®Ÿè¡Œè¨ˆç”»ã¯ã©ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ž
æ‰‹å…ƒã« MySQL 8.0.31 ã®ç’°å¢ƒã‚’ç”¨æ„ã§ããŸã®ã§ï¼Œã“ã¡ã‚‰ã§è©¦ã—ã¦ã¿ã¾ã™.

```sql:å®Ÿè¡Œè¨ˆç”»(MySQL 8.0.31)
explain select * from authors where exists (select * from books where authors.id = books.author_id and published_at > '2022-01-01 00:00:00');

+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
| id | select_type | table   | partitions | type | possible_keys | key       | key_len | ref                | rows | filtered | Extra                            |
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
|  1 | SIMPLE      | authors | NULL       | ALL  | PRIMARY       | NULL      | NULL    | NULL               |    1 |   100.00 | NULL                             |
|  1 | SIMPLE      | books   | NULL       | ref  | author_id     | author_id | 4       | testing.authors.id |    1 |   100.00 | Using where; FirstMatch(authors) |
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
```

å®Ÿã¯ï¼ŒMySQL 8.0.16ã‹ã‚‰ã¯ `EXPLAIN FORMAT=TREE` ã¨ã„ã†è¡¨ç¤ºå½¢å¼ãŒè¿½åŠ ã•ã‚Œï¼ŒPostgreSQL ã¨åŒã˜ã‚ˆã†ã«æœ¨æ§‹é€ ã§å®Ÿè¡Œè¨ˆç”»ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼Ž(MySQL 8.0.18 ã§å°Žå…¥ã•ã‚ŒãŸ `EXPLAIN ANALYZE` ã ã¨å¸¸ã«æœ¨æ§‹é€ ã§è¡¨ç¤ºã•ã‚Œã¾ã™)

```sql:å®Ÿè¡Œè¨ˆç”»(MySQL 8.0.31)
explain format=tree select * from authors where exists (select * from books where authors.id = books.author_id and published_at > '2022-01-01 00:00:00');

+------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                        |
+------------------------------------------------------------------------------------------------+
| -> Nested loop semijoin  (cost=0.70 rows=1)
    -> Table scan on authors  (cost=0.35 rows=1)
    -> Filter: (books.published_at > TIMESTAMP'2022-01-01 00:00:00')  (cost=0.35 rows=1)
        -> Index lookup on books using author_id (author_id=authors.id)  (cost=0.35 rows=1)
|
+------------------------------------------------------------------------------------------------+

```

ã“ã¡ã‚‰ã‚’æ¨¹å½¢å›³ã«ã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼Ž

```mermaid
graph TD

A["â‘£ Nested loop semijoin (1è¡Œç›®)"]
B["â‘  Table scan (2è¡Œç›®)"]
C["â‘¢ Filter (3è¡Œç›®)"]
D["â‘¡ Index lookup (4è¡Œç›®)"]

A --> B
A --> C

C --> D
```

ã“ã‚Œã‚’æ•´ç†ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼Ž
1. `authors` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
2. 1 ã®çµæžœã® `id` (`authors.id`) ã‚’ä½¿ã£ã¦ï¼Œ`books` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¤œç´¢ã™ã‚‹
3. 2 ã®çµæžœã«å¯¾ã—ã¦ï¼Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†ã‚’ã‹ã‘ã‚‹
    * `books.published_at > TIMESTAMP'2022-01-01 00:00:00'` ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã™ã‚‹
4. 1 ã®çµæžœã¨ 3 ã®çµæžœã‚’ Nested loop ã§æº–çµåˆã™ã‚‹

ã“ã“ã§ï¼Œå…ˆç¨‹ã® PostgreSQL ã§ã¯å‡ºã¦ã“ãªã„å˜èªžãŒã„ãã¤ã‹å‡ºã¦ãã¾ã—ãŸï¼Ž

### Index lookup
ã“ã‚Œã¯å˜ã«ï¼Œä½œæˆã—ã¦ã‚ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å…ƒã«æ¤œç´¢ã‚’è¡Œã†ã‚‚ã®ã§ã™ï¼Ž
ä»Šå›žã®å ´åˆã¯ï¼Œ`author_id` ã«å¯¾ã—ã¦å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è²¼ã£ã¦ã„ã‚‹ãŸã‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã„ã¦ã„ã¾ã™ï¼Ž

### semijoin (æº–çµåˆ)
ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆæ–¹æ³•ã®1ã¤ã§ï¼Œã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’å«ã‚€ INï¼ŒEXISTS å¥ã§å‡ºã¦ãã¾ã™ï¼Ž
æº–çµåˆã¯ï¼Œã‚µãƒ–ã‚¯ã‚¨ãƒªã®çµæžœã«ä¸€è‡´ã™ã‚‹è¡ŒãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ï¼Œå¤–å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è¡ŒãŒè¿”ã•ã‚Œã¾ã™ï¼Žã¤ã¾ã‚Šï¼Œã‚µãƒ–ã‚¯ã‚¨ãƒªå†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–ã‚Šé™¤ãï¼Œçµåˆã—ã¾ã™ï¼Ž

### Nested loop semijoin
ä¸€æ–¹ã®ã®ãƒ†ãƒ¼ãƒ–ãƒ«Aã‹ã‚‰ 1 è¡Œãšã¤å–ã‚Šå‡ºã—ï¼Œã‚‚ã†ä¸€æ–¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«Bã®ãã‚Œãžã‚Œã®è¡Œã«çªãåˆã‚ã›ã¦ï¼Œçµåˆæ¡ä»¶ã‚’æº€ãŸã—ãŸå ´åˆã«ï¼Œãƒ†ãƒ¼ãƒ–ãƒ«Aã®è¡Œã‚’å–ã‚Šå‡ºã™ã¨ã„ã†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ï¼Žçµåˆæ–¹æ³•ã¯æº–çµåˆã§ã™ï¼Ž
ä»Šå›žã® `authors` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³çµæžœã¨ï¼Œ`books` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæžœã«å¯¾ã—ã¦ï¼ŒNested loop semijoin ã‚’ PHP ã®ã‚³ãƒ¼ãƒ‰ã§æ›¸ã„ã¦ã¿ã‚‹ã¨ï¼Œæ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™
```php
$authors = []; // ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³çµæžœãŒå…¥ã£ã¦ã„ã‚‹é…åˆ—
$books = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæžœãŒå…¥ã£ã¦ã„ã‚‹é…åˆ—

$results = []; // ã¾ã ç©º
foreach ($authors as $author) {
    foreach ($books as $book) {
        if ($book['book.authors_id'] === $author['author.id']) {
            $results[] = [...$authors] + [...$book];
            break;
        }
    }
}

```

https://dev.mysql.com/doc/refman/8.0/ja/nested-loop-joins.html

ã•ã¦ï¼Œå®Ÿè¡Œè¨ˆç”»ã‚’è¦‹ã‚‹é™ã‚Šï¼Œç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒªã«ã¯ãªã£ã¦ã„ãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸï¼Žãã®ä»£ã‚ã‚Šã«ï¼Œæº–çµåˆã«å¤‰æ›ã•ã‚Œã¦ã„ã¾ã—ãŸã­ï¼Žã“ã‚Œã¯ã‚ªãƒ—ãƒ†ã‚£ãƒžã‚¤ã‚¶ã®æœ€é©åŒ–ã«ã‚ˆã£ã¦å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§ï¼ŒMySQL ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚æ˜Žè¨˜ã•ã‚Œã¦ã„ã¾ã™ï¼Ž

> MySQL 8.0.16 ä»¥é™ã§ã¯ã€EXISTS ã‚µãƒ–ã‚¯ã‚¨ãƒªãƒ¼è¿°èªžã‚’å«ã‚€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã¯ã€åŒç­‰ã® IN ã‚µãƒ–ã‚¯ã‚¨ãƒªãƒ¼è¿°èªžã‚’å«ã‚€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã¨åŒã˜æº–çµåˆå¤‰æ›ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚


https://dev.mysql.com/doc/refman/8.0/ja/semijoins.html

# ä»£æ›¿æ‰‹æ®µã¨ã®æ¯”è¼ƒ
ã“ã‚Œã¾ã§ `whereHas()` ã§å®Ÿç¾ã§ããŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…ˆã§ã®æ¡ä»¶æŒ‡å®šã«ã‚ˆã‚‹å–å¾—å‡¦ç†ã¯ï¼Œå‡¦ç†ãŒé‡ã„ã¨ã„ã†ç†ç”±ã§åˆ¥ã®æ–¹æ³•ã§ä»£æ›¿ã•ã‚Œã¦ã„ã¾ã—ãŸï¼Žãã®æ–¹æ³•ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ï¼Ž

1. æ¡ä»¶æŒ‡å®šã—ãŸã„å­ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦å¤–éƒ¨ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹
2. 1 ã§å–å¾—ã—ãŸå¤–éƒ¨ã‚­ãƒ¼ã‚’ä½¿ã£ã¦è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ `whereIn` ã™ã‚‹

å®Ÿéš›ã« Laravel ã§ã¯ã©ã®ã‚ˆã†ã«æ›¸ãã®ã‹ï¼Œãã®ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼Ž

```php
use App\Models\Author;
use Carbon\Carbon;
use Illuminate\Contracts\Database\Query\Builder;

$users = Author::query()
    ->whereIn(
        'authors.id',
        Book::query()
            ->where('published_at', '>', Carbon::parse('2000-01-01'))
            ->select('books.author_id'),
    )
    ->get();

```

`whereIn()` ã¯ç¬¬ 2 å¼•æ•°ã«ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã®ã§ï¼Œã“ã®ã‚ˆã†ãªæ›¸ãæ–¹ã‚’ã™ã‚Œã° 1 ã‚¯ã‚¨ãƒªã«åŽã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼Ž
ã¾ãŸï¼Œã“ã®ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãŒæœ€çµ‚çš„ã«åãå‡ºã™ SQL ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼Ž

```sql
SELECT *
FROM "authors"
WHERE "authors"."id" IN (
    SELECT "books"."author_id"
    FROM   "books"
    WHERE  "published_at" > '2022-01-01 00:00:00'
);
```
ãã‚Œã§ã¯ï¼Œãã‚Œãžã‚Œå®Ÿè¡Œè¨ˆç”»ã‚’è¦‹ã¦ã¿ã¾ã™ï¼Ž

## Postgres ã§ã®å®Ÿè¡Œè¨ˆç”»

```sql:å®Ÿè¡Œè¨ˆç”»(PostgreSQL 14.4)
explain select * from "authors" where "authors"."id" in (select "books"."author_id" from "books" where "published_at" > '2022-01-01 00:00:00');

                                           QUERY PLAN
-------------------------------------------------------------------------------------------------
 Hash Join  (cost=28.25..58.26 rows=357 width=36)
   Hash Cond: (authors.id = books.author_id)
   ->  Seq Scan on authors  (cost=0.00..22.70 rows=1270 width=36)
   ->  Hash  (cost=26.04..26.04 rows=177 width=4)
         ->  HashAggregate  (cost=24.27..26.04 rows=177 width=4)
               Group Key: books.author_id
               ->  Seq Scan on books  (cost=0.00..23.38 rows=357 width=4)
                     Filter: (published_at > '2022-01-01 00:00:00'::timestamp without time zone)
```

`whereHas()` ã‚’ä½¿ã£ãŸã¨ãã¨å…¨ãåŒã˜å®Ÿè¡Œè¨ˆç”»ã«ãªã‚Šã¾ã—ãŸï¼ŽPostgreSQL ãŒè«–ç†çš„ã«åŒã˜çµæžœã«ãªã‚‹ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã¯åŒã˜å®Ÿè¡Œè¨ˆç”»ã«ãªã‚‹ã‚ˆã†æ­£ã—ãæœ€é©åŒ–ã—ã¦ãã‚Œã¦ã„ãã†ã§ã™ã­ï¼Ž

## MySQL5.7.38 ã§ã®å®Ÿè¡Œè¨ˆç”»

```sql:å®Ÿè¡Œè¨ˆç”»(MySQL 5.7.38)
explain select * from authors where authors.id in (select books.author_id from books where published_at > '2022-01-01 00:00:00');
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
| id | select_type | table   | partitions | type | possible_keys | key       | key_len | ref                | rows | filtered | Extra                            |
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
|  1 | SIMPLE      | authors | NULL       | ALL  | PRIMARY       | NULL      | NULL    | NULL               |    1 |   100.00 | NULL                             |
|  1 | SIMPLE      | books   | NULL       | ref  | author_id     | author_id | 4       | testing.authors.id |    1 |   100.00 | Using where; FirstMatch(authors) |
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
```

ã“ã¡ã‚‰ã¯ï¼Œ`whereHas()` ã®ã‚¯ã‚¨ãƒªã‚’æº–çµåˆã«æœ€é©åŒ–ã—ãŸ MySQL 8.0.31 ã§ã®å®Ÿè¡Œè¨ˆç”»ã¨åŒã˜ã«ãªã‚Šã¾ã—ãŸï¼Ž
ã“ã‚Œã‚’è¦‹ã‚‹é™ã‚Šï¼Œ`whereIn()` ã‚’ä½¿ãˆã°ç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒªã«ã¯ãªã‚‰ãšã«ï¼ŒMySQL 8.0.31 ã‚„ PostgreSQL ã§ `whereHas()` ã‚’ä½¿ã£ãŸå ´åˆã¨åŒç­‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå‡ºãã†ã§ã™ï¼Ž

## MySQL8.0.31 ã§ã®å®Ÿè¡Œè¨ˆç”»

```sql:å®Ÿè¡Œè¨ˆç”»(MySQL 8.0.31)
explain select * from authors where authors.id in (select books.author_id from books where published_at > '2022-01-01 00:00:00');
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
| id | select_type | table   | partitions | type | possible_keys | key       | key_len | ref                | rows | filtered | Extra                            |
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
|  1 | SIMPLE      | authors | NULL       | ALL  | PRIMARY       | NULL      | NULL    | NULL               |    1 |   100.00 | NULL                             |
|  1 | SIMPLE      | books   | NULL       | ref  | author_id     | author_id | 4       | testing.authors.id |    1 |   100.00 | Using where; FirstMatch(authors) |
+----+-------------+---------+------------+------+---------------+-----------+---------+--------------------+------+----------+----------------------------------+
```

```sql:å®Ÿè¡Œè¨ˆç”»ï¼ˆMySQL 8.0.31, æœ¨æ§‹é€ è¡¨ç¤ºï¼‰
explain format=tree select * from authors where authors.id in (select books.author_id from books where published_at > '2022-01-01 00:00:00');
+----------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                                            |
+----------------------------------------------------------------------------------------+
| -> Nested loop semijoin  (cost=0.70 rows=1)
    -> Table scan on authors  (cost=0.35 rows=1)
    -> Filter: (books.published_at > TIMESTAMP'2022-01-01 00:00:00')  (cost=0.35 rows=1)
        -> Index lookup on books using author_id (author_id=authors.id)  (cost=0.35 rows=1)
|
+----------------------------------------------------------------------------------------+
```

ã“ã¡ã‚‰ã‚‚ï¼Œ`whereHas()` ã‚’ä½¿ã£ãŸã¨ãã¨å…¨ãåŒã˜å®Ÿè¡Œè¨ˆç”»ã«ãªã‚Šã¾ã—ãŸï¼ŽMySQL 8.0.16 ä»¥é™ã§ã‚ã‚Œã° PostgreSQL ã¨åŒæ§˜ã«è«–ç†çš„ã«åŒã˜çµæžœã«ãªã‚‹ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã¯åŒã˜å®Ÿè¡Œè¨ˆç”»ã«ãªã‚‹ã‚ˆã†æ­£ã—ãæœ€é©åŒ–ã—ã¦ãã‚Œã¦ã„ãã†ã§ã™ï¼Ž

## æ¯”è¼ƒã—ãŸæ‰€æ„Ÿ
ç›¸é–¢ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’æ™®é€šã®ã‚µãƒ–ã‚¯ã‚¨ãƒªã«ã™ã‚Œã°ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒæ”¹å–„ã™ã‚‹ã“ã¨ã¯çŸ¥è­˜ã¨ã—ã¦ã¯çŸ¥ã£ã¦ã„ã¾ã—ãŸãŒï¼ŒPostgreSQL ã‚„ 8.0.16 ä»¥é™ã® MySQL ã®ã‚ªãƒ–ãƒ†ã‚£ãƒžã‚¤ã‚¶ãŒæœ€é©åŒ–ã—ãŸå ´åˆã®å®Ÿè¡Œè¨ˆç”»ã¨å…¨ãåŒã˜ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã§ããŸã¨ãã¯æ„Ÿå‹•ã—ã¾ã—ãŸï¼Žï¼ˆå°ä¸¦æ„Ÿï¼‰
ã‚ªãƒ–ãƒ†ã‚£ãƒžã‚¤ã‚¶ã™ã’ã‡ã€œï¼

# å…¨ä½“ã®ã¾ã¨ã‚
è¨˜äº‹ã®æ®†ã©ãŒ `whereHas()` ã®è©±ã§ã¯ãªã MySQL ã¨ PostgreSQL ã®å®Ÿè¡Œè¨ˆç”»ã®è©±ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒï¼Œä»Šå›žãŠä¼ãˆã—ãŸã„ã“ã¨ã¯ï¼Œ**`whereHas()` ã¯ã‚‚ã†é…ããªã¯ã„ã‚ˆï¼** ã®ä¸€ç‚¹ã®ã¿ã§ã™w

æœ€çµ‚çš„ã«ã¯ PostgreSQL ã‚‚ MySQL ã‚‚ï¼Œ2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ã¦æ¡ä»¶ã«ã‚ã†ã‚‚ã®ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹æ„Ÿã˜ã«è½ã¡ç€ã„ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸï¼Žçªåˆã®æ–¹æ³•ãŒãã‚Œãžã‚Œé•ã£ã¦ã„ã¦é¢ç™½ã‹ã£ãŸã§ã™ã­ï¼Ž

æ™®æ®µä½•æ°—ãªãä½¿ã£ã¦ã„ã‚‹ Laravel ã®ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã§ã™ãŒï¼Œæœ€çµ‚çš„ã«åãå‡ºã•ã‚ŒãŸã‚¯ã‚¨ãƒªãŒ DB ä¸Šã§ã©ã®ã‚ˆã†ãªæ‰‹ç¶šãã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚ŒçµæžœãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹ã®ã‹ï¼Œå®Ÿè¡Œè¨ˆç”»ã‚’è¦‹ã¦ã¿ã‚‹ã“ã¨ã§æ˜Žã‚‰ã‹ã«ãªã‚Šã¾ã™ï¼Ž

Eloquent ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ç”Ÿ SQL ã‚’æ›¸ãã“ã¨ã¯å°‘ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã—ï¼Œã‚¯ã‚¨ãƒªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æœ¬æ°—ã§ã‚„ã‚‹æ©Ÿä¼šã‚‚ã‚ã¾ã‚Šãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒï¼Œã“ã†ã‚„ã£ã¦å®Ÿè¡Œè¨ˆç”»ã‚’çœºã‚ãªãŒã‚‰ã‚¯ã‚¨ãƒªã‚’ã„ã˜ã£ã¦ã¿ãŸã‚Šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è²¼ã‚Šæ–¹ã‚’å·¥å¤«ã—ã¦ã¿ãŸã‚Šã—ã¦éŠã‚“ã§ã¿ã‚‹ã¨ï¼Œæ„å¤–ã¨æ™‚é–“ãŒæº¶ã‘ã¦ã„ãã¾ã™ï¼ˆä½“é¨“è«‡ï¼‰

ãŠæ­£æœˆä¼‘ã¿ã¯ Laravel ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ï¼Œå®Ÿè¡Œè¨ˆç”»ã‚’çœºã‚ã¦æ™‚é–“ã‚’æ½°ãã†ã¨æ€ã„ã¾ã™ðŸŽï¼Ž



explain format=tree select * from authors where authors.id in (select books.author_id from books where published_at > '2022-01-01 00:00:00');
