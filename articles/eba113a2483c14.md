---
title: "ã„ã‹ã«ã—ã¦ JSONB ã‚’å®‰å…¨ã«æ‰±ã†ã‹"
emoji: "ğŸ­ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["PostgreSQL", "JSONB"]
published: true,
publication_name: "yumemi_inc"
---

# ã¯ã˜ã‚ã«

Postgres ã«ã¯ JSON/JSONB ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿å‹ãŒã‚ã‚Šã¾ã™ãŒï¼ŒJSONB ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ãƒŠãƒªå½¢å¼ã§æ ¼ç´ã™ã‚‹ãŸã‚ã‚¤ãƒ³ã‚µãƒ¼ãƒˆæ™‚ã«å¤‰æ›ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã‚ã‚‹ã‚‚ã®ã®ï¼Œãã®å¾Œã®å‡¦ç†ãŒéå¸¸ã«é«˜é€Ÿã§ã‚ã‚‹ä¸Šã«ï¼Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è²¼ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ï¼Œå®Ÿç”¨ä¸Šã¯ JSONB ã‚’ä½¿ã†ã®ãŒä¸€èˆ¬çš„ã§ã™ï¼

https://www.postgresql.org/docs/17/datatype-json.html

ä¸€æ–¹ã§ï¼Œãã‚‚ãã‚‚ RDB ã®ã‚ˆã†ãªã‚¹ã‚­ãƒ¼ãƒã®å³æ ¼ãªå‹ä»˜ã‘ã‚’ã—ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§åŠæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ JSON ã‚’æ‰±ã†ã“ã¨è‡ªä½“ãŒã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ã¨ã„ã†æŒ‡æ‘˜ã‚‚ã‚ã‚Šã¾ã™ï¼

ã—ã‹ã—ãªãŒã‚‰ï¼Œé©åˆ‡ã«è¨­è¨ˆï¼Œé‹ç”¨ã™ã‚‹ã“ã¨ã§å³æ ¼ãª RDB ã§æŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ã“ã¨ãŒã§ãï¼Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¾ã®å¹…ã‚’åºƒã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

æœ¬è¨˜äº‹ã§ã¯ï¼ŒJSONB ã‚’å¯èƒ½ãªé™ã‚Šå®‰å…¨ã«æ‰±ã†ãŸã‚ã®å®Ÿè·µçš„ãªå·¥å¤«ã‚’ç´¹ä»‹ã—ã¾ã™ï¼

# JSON Schema ã‚’ä½¿ã£ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Check Constraint ã«ã™ã‚‹

Postgres ã§ã¯ï¼ŒJSONB ã«å¯¾ã—ã¦ã‚¹ã‚­ãƒ¼ãƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†æ©Ÿèƒ½ã¯æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒï¼Œæ—¢å­˜ã®ä»•çµ„ã¿ã¨æ‹¡å¼µã‚’ä½¿ã£ã¦ JSON Schema ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

## JSON Schema ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†æ‹¡å¼µ

Postgres ã§ JSON Schema ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æ‰‹æ®µã¨ã—ã¦ï¼Œä»¥ä¸‹ã®ï¼’ã¤ãŒã‚ã‚Šã¾ã™:

- Postgres ã®æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ï¼Œãã‚Œä½¿ã†
- PL/pgSQLã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹

å‰è€…ã¯ï¼Œè‡ªåˆ†ã§æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ï¼Œæ‹¡å¼µã®é¸å®šãƒ»æ¤œè¨ãŒå¿…è¦ã ã£ãŸã‚Šï¼ŒPostgres ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«ã‚ˆã£ã¦ã¯æ‹¡å¼µã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã ã£ãŸã‚Šã¨ï¼Œæ‰‹é–“ãŒã‹ã‹ã‚‹ã‚‚ã®ã®ï¼Œé«˜å“è³ªãªæ‹¡å¼µã‚’é¸æŠã™ã‚Œã°å‹•ä½œã‚‚å®‰å¿ƒã§ã™ï¼
ãŸã ã—ï¼Œåˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒï¼ŒDBaaS ã«ã‚ˆã£ã¦ã¯æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ããªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚æ³¨æ„ãŒå¿…è¦ã§ã™ï¼

å¾Œè€…ã¯ï¼ŒPostgres ã®æ¨™æº–æ©Ÿèƒ½ã®ã¿ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ï¼Œæ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒãªãï¼Œãƒ™ãƒ³ãƒ€ãƒ¼ã®åˆ¶é™ã‚’å—ã‘ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ï¼
ãŸã ã—ï¼Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ï¼Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»•æ§˜ãŒè¤‡é›‘ã«ãªã‚‹ã¨ï¼Œãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒé›£ã—ããªã‚‹ä¸Šã«ï¼Œå“è³ªã®ä¿è¨¼ãŒé›£ã—ããªã‚Šã¾ã™ï¼

:::message alert

Postgres ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªæ³¨æ„æ›¸ããŒã‚ã‚Šã¾ã™ï¼

> PostgreSQL assumes that CHECK constraints' conditions are immutable, that is, they will always give the same result for the same input row. This assumption is what justifies examining CHECK constraints only when rows are inserted or updated, and not at other times. (The warning above about not referencing other table data is really a special case of this restriction.)
>
> An example of a common way to break this assumption is to reference a user-defined function in a CHECK expression, and then change the behavior of that function. PostgreSQL does not disallow that, but it will not notice if there are rows in the table that now violate the CHECK constraint. That would cause a subsequent database dump and restore to fail. The recommended way to handle such a change is to drop the constraint (using ALTER TABLE), adjust the function definition, and re-add the constraint, thereby rechecking it against all table rows.

ã¤ã¾ã‚Šï¼ŒJSON ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’è‡ªåˆ†ã§å®šç¾©ã™ã‚‹å ´åˆï¼Œã‚ã¨ã‹ã‚‰ãƒ­ã‚¸ãƒƒã‚¯ã«ãƒã‚°ãŒã‚ã£ã¦ä¿®æ­£ã—ã¦ã‚‚ï¼Œãã®ä¿®æ­£ãŒåæ˜ ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ï¼Œæ³¨æ„ãŒå¿…è¦ã§ã™ï¼
ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ï¼Œä¸€åº¦ Check åˆ¶ç´„ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ï¼Œä¿®æ­£ã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨ã—ã¦ã‹ã‚‰å†åº¦ Check åˆ¶ç´„ã‚’é©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼

:::

## æœ¬è¨˜äº‹ã§ã®é¸å®š

æœ¬è¨˜äº‹ã§ã¯ï¼Œå‰è€…ã®æ‹¡å¼µã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã‚’å–ã‚Šï¼Œ`supabase/pg_jsonschema` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ï¼

https://github.com/supabase/pg_jsonschema

å‹•ä½œæ¤œè¨¼ã®ãŸã‚ï¼Œä¸Šè¨˜ã®æ‹¡å¼µã‚’å°å…¥ã—ãŸ Postgres 16 ç”¨ã® Docker ç’°å¢ƒã‚’ç”¨æ„ã—ã¾ã—ãŸï¼

https://github.com/fuwasegu/pgsql-json-schema-validation-docker

### PL/pgSQL ã‚’ä½¿ã†å ´åˆ

å®Ÿéš›è‡ªåˆ†ãŒå‚ç”»ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ï¼ŒPL/pgSQL ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ãŸé–¢æ•°ã§ JSON Schema ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼

ãã®éš›ã«åˆ©ç”¨ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ï¼Œä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚‚ã®ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸ

https://github.com/gavinwahl/postgres-json-schema

ãŸã ã—ï¼Œã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ **JSON Schema Draft v4 Spec ã¾ã§**ã®å¯¾å¿œã§ï¼Œå°‘ã€…å¤ã„ãŸã‚æ³¨æ„ãŒå¿…è¦ã§ã™ï¼

### `supabase/pg_jsonschema` ã«ã¤ã„ã¦

`supabase/pg_jsonschema` ã¯ JSON/JSONB å‹ã«å¯¾ã—ã¦ JSON Schema ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã®æ‹¡å¼µã§ã™ï¼
ã“ã®æ‹¡å¼µã¯ã„ãã¤ã‹ã®é–¢æ•°ã‚’æä¾›ã—ã¾ã™ãŒï¼Œæœ¬è¨˜äº‹ã§ä½¿ã†ã®ã¯ `jsonb_matches_schema()` é–¢æ•°ã§ã™ï¼

```sql
jsonb_matches_schema(schema json, instance jsonb) returns bool
```

è¦‹ã¦ã‚ã‹ã‚‹é€šã‚Šï¼Œ`jsonb_matches_schema()` é–¢æ•°ã¯ JSON Schema ã¨æ¤œè¨¼å¯¾è±¡ã® JSONB ã‚’å¼•æ•°ã«å–ã‚Šï¼Œæ¤œè¨¼å¯¾è±¡ã® JSONB ãŒ JSON Schema ã«ãƒãƒƒãƒã™ã‚‹ã‹ã©ã†ã‹ã‚’è¿”ã™é–¢æ•°ã§ã™ï¼

## ã‚·ãƒ³ãƒ—ãƒ«ãª Check åˆ¶ç´„

ã¾ãšã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã—ã¾ã™ï¼

```sql
create table users (
    id serial primary key,
    name text not null,
    roles jsonb,

    constraint users_roles_chk check(jsonb_matches_schema(
        '{
            "type": "array",
            "items": {
                "type": "string"
            },
            "minItems": 1,
            "uniqueItems": true
        }',
        roles
    ))
);
```

Postgres ã® Check åˆ¶ç´„ã¯ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦æ¡ä»¶å¼è¨­å®šã™ã‚‹ã‚‚ã®ã§ï¼Œ`jsonb_matches_schema()` ã¯ bool å€¤ã‚’è¿”å´ã™ã‚‹ãŸã‚ `check(jsonb_matches_schema(...), {column})` ã¨æ›¸ãã“ã¨ãŒã§ãã¾ã™ï¼

https://www.postgresql.jp/document/16/html/ddl-constraints.html

ã“ã‚Œã§ï¼Œå®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã—ã¦ã¿ã¦ï¼ŒCheck åˆ¶ç´„ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ï¼

### ãƒã‚§ãƒƒã‚¯ãŒé€šã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

```sql
insert into users(name, roles)
values ('Fuwasegu', '["admin", "article_editor"]');

Query 1 OK: INSERT 0 1, 1 row affected
```

### ãƒã‚§ãƒƒã‚¯ãŒé€šã‚‰ãªã„ãƒ‘ã‚¿ãƒ¼ãƒ³

`minItems: 1` ã«é•åã—ã¦ã„ã‚‹

```sql
insert into users(name, roles)
values ('Yametaro', '[]');

Query 1 ERROR at Line 1: : ERROR:  new row for relation "users" violates check constraint "users_roles_chk"
DETAIL:  Failing row contains (2, Yametaro, []).
```

`items.type: string` ã«é•åã—ã¦ã„ã‚‹

```sql
insert into users(name, roles)
values ('Yametaro', '[1, 2, 3]');

Query 1 ERROR at Line 1: : ERROR:  new row for relation "users" violates check constraint "users_roles_chk"
DETAIL:  Failing row contains (3, Yametaro, [1, 2, 3]).
```

ã“ã®ã‚ˆã†ã«ï¼Œ`jsonb_matches_schema()` + Check åˆ¶ç´„ ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ï¼Œãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ã‚µãƒ¼ãƒˆæ™‚ã« JSON ã®ã‚¹ã‚­ãƒ¼ãƒãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

## è¤‡é›‘ãª Check åˆ¶ç´„

ã•ã¦ï¼Œã“ã‚Œã ã‘ã§ã‚‚ååˆ† JSONB ã‚’å®‰å…¨ã«æ‰±ã†ä»•çµ„ã¿ãŒæ•´ã„ã¾ã—ãŸãŒï¼Œå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã ã¨ã‚‚ã†å°‘ã—å‡ã£ãŸã“ã¨ãŒã—ãŸããªã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ï¼

### ä»®æƒ³ã®è¦ä»¶

ä»Šå›ï¼Œä»®æƒ³ã®è¦ä»¶ã¨ã—ã¦ï¼Œã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚µã‚¤ãƒˆã‚’è€ƒãˆã¾ã™ï¼
ã“ã®ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚µã‚¤ãƒˆã§ã¯ï¼Œ

- å®¶é›»
- æœ¬
- è¡£é¡

ã‚’ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦æ‰±ã†ã“ã¨ã«ã—ã¾ã™ï¼

ãã“ã§ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãª `products` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è€ƒãˆã¾ã™

```sql
create table products (
    id uuid primary key default gen_random_uuid() not null,
    name text not null, -- å•†å“å
    category text not null, -- å•†å“ã‚«ãƒ†ã‚´ãƒª
    price integer not null,-- é‡‘é¡
    detail jsonb not null -- å•†å“è©³ç´°
);
```

ä»Šå›ï¼Œå•†å“è©³ç´°ã¨ã—ã¦ JSON ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸï¼
ã“ã®è¦ä»¶ã§ã¯ï¼Œ`detail` ã®ã‚¹ã‚­ãƒ¼ãƒã¯ `category` ã«ã‚ˆã£ã¦å¤‰ã‚ã‚Šã¾ã™ï¼

#### å®¶é›»ã®å•†å“è©³ç´°

:::details ä¾‹

```json
{
    "brand": "Sony",
    "specifications": {
        "voltage": "100V",
        "power_consumption": "1500W"
    },
    "warranty_period": "1 year",
    "dimensions": {
        "width": 30,
        "height": 20,
        "depth": 10
    },
    "features": ["Bluetooth", "Wi-Fi", "USB"]
}
```

:::

:::details JSON Schema

```json
{
    "$schema":  "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "properties": {
        "brand": {
            "type": "string",
            "description": "ãƒ–ãƒ©ãƒ³ãƒ‰"
        },
        "specifications": {
            "type": "object",
            "description": "ä»•æ§˜",
            "properties": {
                "voltage": {
                    "type": "string",
                    "description": "é›»åœ§",
                    "pattern": "^[0-9]+V$"
                },
                "power_consumption": {
                    "type": "string",
                    "description": "æ¶ˆè²»é›»åŠ›",
                    "pattern": "^[0-9]+W$"
                }
            },
            "additionalProperties": false,
            "required": ["voltage", "power_consumption"]
        },
        "warranty_period": {
            "type": "string",
            "description": "ä¿è¨¼æœŸé–“"
        },
        "dimensions": {
            "type": "object",
            "description": "å¯¸æ³•",
            "properties": {
                "width": {
                    "type": "number",
                    "description": "å¹…"
                },
                "height": {
                    "type": "number",
                    "description": "é«˜ã•"
                },
                "depth": {
                    "type": "number",
                    "description": "å¥¥è¡Œã"
                }
            },
            "additionalProperties": false,
            "required": ["width", "height", "depth"]
        },
        "features": {
            "type": "array",
            "description": "æ©Ÿèƒ½",
            "items": {
                "type": "string",
                "minLength": 0
            }
        }
    },
    "additionalProperties": false,
    "required": ["brand", "specifications", "warranty_period", "dimensions", "features"]
}
```

:::

#### æœ¬ã®å•†å“è©³ç´°

:::details ä¾‹

```json
{
    "author": "Taro Yamada",
    "publisher": "Gakken",
    "publication_date": "2022-01-01",
    "page_count": 450,
    "language": "Japanese",
    "genre": "Novel",
    "chapters": [
        {
            "title": "Chapter 1",
            "start_page": 1,
            "end_page": 50
        },
        {
            "title": "Chapter 2",
            "start_page": 51,
            "end_page": 100
        }
    ]
}
```

:::

:::details JSON Schema

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "properties": {
        "author": {
            "type": "string",
            "description": "è‘—è€…"
        },
        "publisher": {
            "type": "string",
            "description": "å‡ºç‰ˆç¤¾"
        },
        "publication_date": {
            "type": "string",
            "description": "å‡ºç‰ˆæ—¥",
            "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        },
        "page_count": {
            "type": "integer",
            "description": "ãƒšãƒ¼ã‚¸æ•°"
        },
        "language": {
            "type": "string",
            "description": "è¨€èª",
            "enum": ["Japanese", "English", "Chinese", "Korean"]
        },
        "genre": {
            "type": "string",
            "description": "ã‚¸ãƒ£ãƒ³ãƒ«"
        },
        "chapters": {
            "type": "array",
            "description": "ç« ",
            "items": {
                "type": "object",
                "properties": {
                    "title": {
                        "type": "string",
                        "description": "ã‚¿ã‚¤ãƒˆãƒ«"
                    },
                    "start_page": {
                        "type": "integer",
                        "description": "é–‹å§‹ãƒšãƒ¼ã‚¸"
                    },
                    "end_page": {
                        "type": "integer",
                        "description": "çµ‚äº†ãƒšãƒ¼ã‚¸"
                    }
                },
                "additionalProperties": false
            },
            "minItems": 1,
            "additionalItems": false
        }
    },
    "additionalProperties": false,
    "required": ["author", "publisher", "publication_date", "page_count", "language", "genre"]
}
```

:::

#### è¡£é¡ã®å•†å“è©³ç´°

:::details ä¾‹

```json
{
    "brand": "Nike",
    "size": {
        "type": "M",
        "measurements": {
            "chest": 100,
            "waist": 80,
            "hips": 100
        }
    },
    "color": "Blue",
    "material": {
        "main": "Cotton",
        "lining": "Polyester"
    },
    "washing_instructions": ["Hand washable", "Do not bleach", "Iron low heat"]
}
```

:::

:::details JSON Schema

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "properties": {
        "brand": {
            "type": "string",
            "description": "ãƒ–ãƒ©ãƒ³ãƒ‰"
        },
        "size": {
            "type": "object",
            "description": "ã‚µã‚¤ã‚º",
            "properties": {
                "type": {
                    "type": "string",
                    "description": "ã‚¿ã‚¤ãƒ—",
                    "enum": ["XS","S", "M", "L", "XL"]
                },
                "measurements": {
                    "type": "object",
                    "description": "å¯¸æ³•",
                    "properties": {
                        "chest": {
                            "type": "number",
                            "description": "èƒ¸å›²"
                        },
                        "waist": {
                            "type": "number",
                            "description": "ã‚¦ã‚¨ã‚¹ãƒˆ"
                        },
                        "hips": {
                            "type": "number",
                            "description": "ãƒ’ãƒƒãƒ—"
                        }
                    },
                    "additionalProperties": false,
                    "required": ["chest", "waist", "hips"]
                }
            },
            "additionalProperties": false,
            "required": ["type", "measurements"]
        },
        "color": {
            "type": "string",
            "description": "è‰²"
        },
        "material": {
            "type": "object",
            "description": "ç´ æ",
            "properties": {
                "main": {
                    "type": "string",
                    "description": "ãƒ¡ã‚¤ãƒ³ç´ æ"
                },
                "lining": {
                    "type": "string",
                    "description": "è£åœ°"
                }
            },
            "additionalProperties": false,
            "required": ["main"]
        },
        "washing_instructions": {
            "type": "array",
            "description": "æ´—æ¿¯æ–¹æ³•",
            "items": {
                "type": "string"
            }
        }
    },
    "additionalProperties": false,
    "required": ["brand", "size", "color", "material", "washing_instructions"]
}
```

:::

### åŒä¸€ã‚«ãƒ©ãƒ ã«è¤‡æ•°ã® JSON Schema ã‚’é©ç”¨ã™ã‚‹

åŒä¸€ã‚«ãƒ©ãƒ ã§è¤‡æ•°ã® JSON Schema ã‚’é©ç”¨ã™ã‚‹å ´åˆï¼Œè€ƒãˆã‚‰ã‚Œã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®2ã¤ã§ã™

- JSON Schema ã®æ©Ÿèƒ½ã§é ‘å¼µã‚‹
- Check åˆ¶ç´„ + CASE å¼ã§é ‘å¼µã‚‹

#### JSON Schema ã®æ©Ÿèƒ½ã§é ‘å¼µã‚‹

JSON Schema ã«ã¯ï¼Œ`oneOf` ã¨ã„ã†ä»•çµ„ã¿ãŒã‚ã‚Šï¼Œã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§è¤‡æ•°ã® JSON Schema ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

â€» åˆ†é‡ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«ï¼Œã‚«ãƒ†ã‚´ãƒªã¯ æœ¬ï¼Œå®¶é›» ã®2ã¤ã®ã¿ã‚’è€ƒãˆã¾ã™ï¼

:::details JSON Schemaï¼ˆoneOf ã‚’ä½¿ã†ï¼‰

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "oneOf":[
        {
            "type":"object",
            "properties":{
                "author":{
                "type":"string"
                },
                "page_count":{
                "type":"integer"
                }
            },
            "required":[
                "author",
                "page_count"
            ]
        },
        {
            "type":"object",
            "properties":{
                "brand":{
                "type":"string"
                },
                "color":{
                "type":"string"
                }
            },
            "required":[
                "brand",
                "color"
            ]
        }
    ]
}
```

:::

ãŸã ã—ï¼Œ`oneOf` ã§ã¯ï¼Œ`category` ã«ã‚ˆã£ã¦ `detail` ã®ã‚¹ã‚­ãƒ¼ãƒãŒå¤‰ã‚ã‚‹ã‚ˆã†ãªã“ã¨ã¯è¡¨ç¾ã§ãã¾ã›ã‚“ï¼

ã‚‚ã—ï¼ŒJSON Schema spec ãŒ Draft v7 ä»¥ä¸Šã§ã‚ã‚Œã°ï¼Œ`if then else` ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ï¼
ã“ã®å ´åˆï¼ŒJSON è‡ªèº«ã« `category` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ï¼Œãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ã¨æƒ…å ±ãŒé‡è¤‡ã—ã¦ã—ã¾ã„ã¾ã™ï¼
ã—ãŸãŒã£ã¦ï¼Œã“ã®å ´åˆã¯åˆ¥é€” `category` ã®å†…å®¹ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã»ã†ãŒè‰¯ã„ã§ã—ã‚‡ã†ï¼

:::details JSON Schemaï¼ˆif then else ã‚’ä½¿ã†ï¼‰

```json
{
   "$schema":"http://json-schema.org/draft-07/schema#",
   "properties":{
      "category":{
         "type":"string",
         "enum":[
            "book",
            "electronics"
         ]
      }
   },
   "required":[
      "category"
   ],
   "if":{
      "properties":{
         "category":{
            "const":"book"
         }
      }
   },
   "then":{
      "type":"object",
      "properties":{
         "author":{
            "type":"string"
         },
         "page_count":{
            "type":"integer"
         }
      },
      "required":[
         "author",
         "page_count"
      ]
   },
   "else":{
      "if":{
         "properties":{
            "category":{
               "const":"electronics"
            }
         }
      },
      "then":{
         "type":"object",
         "properties":{
            "brand":{
               "type":"string"
            },
            "color":{
               "type":"string"
            }
         },
         "required":[
            "brand",
            "color"
         ]
      }
   }
}
```

:::

ã“ã‚Œã§ã‚‚åŒæ§˜ã«ï¼Œcategory ã«ã‚ˆã£ã¦æ¡ç”¨ã™ã‚‹ JSON Schema ã‚’å¤‰ãˆã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒï¼Œif-then-else ã¯ï¼Œã‚ãã¾ã§ `if else` ã®ã¿ã§ï¼Œä¸€èˆ¬çš„ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ã‚ã‚‹ `else if` ã®ã‚ˆã†ãªã‚‚ã®ãŒå­˜åœ¨ã—ãªã„ã®ã§ï¼Œä¸¦åˆ—ã«åˆ†å²ã‚’ä¸¦ã¹ãŸã„å ´åˆã¯ **then ã®ä¸­ã« if-then-else ã‚’å…¥ã‚Œå­ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Š** å¤§å¤‰èª­ã¿ã¥ã‚‰ããªã‚Šã¾ã™ï¼

#### Check åˆ¶ç´„ + CASE å¼ã§é ‘å¼µã‚‹

å€‹äººçš„ã«ã¯ã“ã®è¨˜äº‹ã®ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒã§ã‚‚ã‚ã‚Šã¾ã™ï¼

Postgres ã«ã¯ CASE å¼ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šï¼Œã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§ Check åˆ¶ç´„é©ç”¨æ™‚ã« JSON Schema ã‚’**å‹•çš„ã«æ±ºå®šã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ï¼

https://www.postgresql.jp/document/7.3/user/functions-conditional.html

:::details JSON Schema ã‚’å‹•çš„ã«æ±ºå®šã™ã‚‹

```sql
create table products (
    id uuid primary key default gen_random_uuid() not null,
    name text not null, -- å•†å“å
    category text not null, -- å•†å“ã‚«ãƒ†ã‚´ãƒª
    price integer not null,-- é‡‘é¡
    detail jsonb not null, -- å•†å“è©³ç´°

    constraint products_detail_chk check(jsonb_matches_schema(
        case category
            when 'book' then '{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "author": {
                        "type": "string"
                    },
                    "page_count": {
                        "type": "integer"
                    }
                },
                "required": ["author", "page_count"]
            }'::json
            when 'electronics' then '{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "brand": {
                        "type": "string"
                    },
                    "color": {
                        "type": "string"
                    }
                },
                "required": ["brand", "color"]
            }'::json
        end,
        detail
    ))
);
```

:::

ã“ã“ã§ï¼Œcategory ã«äºˆæœŸã—ãªã„å€¤ãŒå…¥ã£ã¦ããŸã¨ãï¼Œã©ã®ã‚ˆã†ãªæŒ™å‹•ã‚’ã™ã‚‹ã‹ã‚’è€ƒãˆã¦ã¿ã¾ã™ï¼

ä¾‹ãˆã°ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãª INSERT ã‚’è¡Œã£ãŸã¨ã—ã¾ã™ï¼

```sql
insert into products (name, category, price, detail) values ('Foo', 'foo', 100, '{}');

Query 1 OK: INSERT 0 1, 1 row affected
```

æ®‹å¿µãªãŒã‚‰ï¼Œã“ã® INSERT ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã›ã‚“ï¼è¦ä»¶æ¬¡ç¬¬ã§ã¯ã‚ã‚Šã¾ã™ãŒï¼Œå¤šãã®å ´åˆï¼Œã“ã®ã‚ˆã†ãªæœŸå¾…ã—ã¦ã„ãªã„å…¥åŠ›ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã¯é¿ã‘ãŸã„ã¨ã“ã‚ã§ã™ï¼
ã“ã“ã§ï¼Œã¾ãšæœ€åˆã«è€ƒãˆã‚‰ã‚Œã‚‹å¯¾ç­–ã¨ã—ã¦ã¯ï¼Œ`category` ã«å¯¾ã—ã¦ `enum` åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ã“ã¨ã§ã™ï¼

Postgres ã«ã¯åˆ—æŒ™å‹ãŒã‚ã‚Šã¾ã™ã®ã§ï¼Œã“ã‚Œã‚’ä½¿ã£ã¦ `category` ã«å¯¾ã—ã¦ `enum` åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

```sql
create type category_enum as enum ('book', 'electronics');

create table products (
    id uuid primary key default gen_random_uuid() not null,
    name text not null,
    category category_enum not null,
    price integer not null,
    detail jsonb not null,

    -- Check åˆ¶ç´„ã¯çœç•¥
);
```

```sql
insert into products (name, category, price, detail) values ('Foo', 'foo', 100, '{}');

Query 1 ERROR at Line 41: : ERROR:  invalid input value for enum category_enum: "foo"
LINE 1: ...ts (name, category, price, detail) values ('Foo', 'foo', 100...
                                                             ^
```

ãŸã ã—ï¼Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦ã¯ Enum ã‚’å®šç¾©ã—ãŸããªã„å ´åˆãŒã‚ã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ï¼ˆãã®ç†ç”±ã¯ï¼Œæ¤œç´¢ã™ã‚‹ã¨ã„ãã‚‰ã§ã‚‚å‡ºã¦ãã¾ã™ï¼‰ï¼
ãã®å ´åˆã¯ï¼Œ

- category ã«å¯¾ã—ã¦ Check åˆ¶ç´„ã‚’è¨­ã‘ã‚‹
  - å®Ÿè³ª Enum ã¨åŒã˜ã‚ˆã†ãªåˆ¶ç´„
- detail ã® Check åˆ¶ç´„ã§ã® CASE å¼ã«ãŠã„ã¦ï¼ŒäºˆæœŸã—ãªã„ category ãŒæ¥ãŸå ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹

ã®ï¼’ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼

ã¾ãšï¼Œcategory ã«å¯¾ã—ã¦ Check åˆ¶ç´„ã‚’è¨­ã‘ã‚‹å ´åˆã¯ï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼

```sql
create table products (
    id uuid primary key default gen_random_uuid() not null,
    name text not null,
    category text not null,
    price integer not null,
    detail jsonb not null,

    constraint products_category_chk check(category in ('book', 'electronics'))
);
```

ã“ã®å ´åˆï¼Œ`category` ã«äºˆæœŸã—ãªã„å€¤ãŒå…¥ã£ã¦ããŸå ´åˆï¼Œã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼

```sql
insert into products (name, category, price, detail) values ('Foo', 'foo', 100, '{}');

Query 1 ERROR at Line 1: : ERROR:  new row for relation "products" violates check constraint "products_category_chk"
DETAIL:  Failing row contains (da811b3f-387f-4652-868e-5ba21d7ec7b7, Foo, foo, 100, {}).
```

æ¬¡ã«ï¼Œdetail ã® Check åˆ¶ç´„ã§ã® CASE å¼ã«ãŠã„ã¦ï¼ŒäºˆæœŸã—ãªã„ category ãŒæ¥ãŸå ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹å ´åˆã¯ï¼ŒCASE å¼ã¨ jsonb_matches_schema ã®é †åºã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ï¼

:::details äºˆæœŸã—ãªã„ category ãŒæ¥ãŸå ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

```sql
create table products (
    id uuid primary key default gen_random_uuid() not null,
    name text not null,
    category text not null,
    price integer not null,
    detail jsonb not null,

    constraint products_detail_chk check(
        case category
            when 'book' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "author": {
                        "type": "string"
                    },
                    "page_count": {
                        "type": "integer"
                    }
                },
                "required": ["author", "page_count"]
            }'::json, detail)
            when 'electronics' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "brand": {
                        "type": "string"
                    },
                    "color": {
                        "type": "string"
                    }
                },
                "required": ["brand", "color"]
            }'::json, detail)
            else false
        end
    )
);
```

:::

```sql
insert into products (name, category, price, detail) values ('Foo', 'foo', 100, '{}');

Query 1 ERROR at Line 1: : ERROR:  new row for relation "products" violates check constraint "products_detail_chk"
DETAIL:  Failing row contains (c8517952-0399-42e0-aba7-a5cd488116fc, Foo, foo, 100, {}).
```

ã“ã‚Œã¾ã§ã¯ CASE å¼ãŒ jsonb_matches_schema ã«æ¸¡ã™ JSON Schema ã‚’å‹•çš„ã«æ±ºå®šã™ã‚‹å½¢ã«ã—ã¦ã„ã¾ã—ãŸãŒï¼Œã“ã®å ´åˆã¯ CASE å¼ãŒ jsonb_matches_schema ã®çµæœï¼ˆtrue ã‹ falseï¼‰ã‚’è¿”ã™å½¢ã«ã—ã¦ã„ã¾ã™ï¼
ã“ã†ã™ã‚‹ã“ã¨ã§ï¼ŒCASE å¼ã® ELSE ç¯€ã§ false ã‚’è¿”ã™ã¨ Check åˆ¶ç´„ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼

ãŸã ã—ï¼Œã“ã‚Œã¯æœ¬æ¥ category ã®ã‚¨ãƒ©ãƒ¼ã§ã‚ã‚‹ã¹ãã‚‚ã®ã‚’ detail ã®ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¿”ã—ã¦ã„ã‚‹ãŸã‚ï¼Œæœ¬è³ªçš„ã§ã¯ãªãã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‹ã‚Šã¥ã‚‰ããªã‚‹ã¨ã„ã†ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼

### ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰

ã•ã¦ï¼Œã“ã“ã¾ã§ JSON Schema ã‚’ç”¨ã„ãŸæŸ”è»Ÿã§å®‰å…¨ãª JSONB å‹ã‚«ãƒ©ãƒ ã®å®šç¾©æ–¹æ³•ã‚’è¦‹ã¦ãã¾ã—ãŸï¼

ã—ã‹ã—ï¼Œå®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯æœ€åˆã® Schema å®šç¾©å¾Œã«ï¼Œã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã‚’è¡Œã†ã“ã¨ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼

ä¾‹ãˆã°ï¼Œä»Šå›å–ã‚Šæ‰±ã£ã¦ã„ã‚‹ products ãƒ†ãƒ¼ãƒ–ãƒ«ã§è¨€ãˆã°ï¼Œcategory ã®è¿½åŠ ã«ä¼´ã†æ–°ã—ã„ details ã® Schema ã®è¿½åŠ ã‚„ï¼Œã™ã§ã«ã‚ã‚‹ category ã® details ã«ãŠã„ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¿½åŠ ã•ã‚ŒãŸã‚Šå‰Šé™¤ã•ã‚ŒãŸã‚Šã™ã‚‹ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼

ã“ã®ã‚ˆã†ãªå ´åˆï¼Œä¸€èˆ¬çš„ãª Check åˆ¶ç´„ã®æ›´æ–°æ–¹æ³•ã¨åŒæ§˜ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªæ‰‹é †ã‚’è¸ã‚€ã“ã¨ã«ãªã‚Šã¾ã™ï¼

1. å¤‰æ›´ã—ãŸã„ Check åˆ¶ç´„ã‚’ä¸€åº¦å‰Šé™¤ã™ã‚‹
2. æ–°ã—ã„ Check åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹

ã“ã®ã¨ãï¼Œæ–°ã—ã„ Check åˆ¶ç´„ã‚’è¿½åŠ ã™ã‚‹éš›ã«ï¼Œæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒæ–°ã—ã„ Check åˆ¶ç´„ã‚’æº€ãŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼

ã“ã‚Œã¯ï¼Œã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãŒå¤šã‘ã‚Œã°å¤šã„ã»ã©ï¼Œãƒã‚§ãƒƒã‚¯ã«å¿…è¦ãªæ™‚é–“ãŒé•·ããªã‚‹ãŸã‚ï¼Œã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¤§ãããªã‚‹ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼

ã“ã‚Œã«å¯¾ã™ã‚‹è§£æ±ºç­–ã¨ã—ã¦ã¯ï¼Œ `NOT VALID` ã‚’ã¤ã‘ã¦æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ Check åˆ¶ç´„ã®ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã¨ã„ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼ã“ã®éš›ï¼Œã‚ã¨ã‹ã‚‰ `VALIDATE CONSTRAINT` ã‚’å®Ÿè¡Œã—ã¦ï¼Œæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ Check åˆ¶ç´„ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ï¼

ãŸã ã—ï¼Œä»Šå›ã®ãƒ†ãƒ¼ãƒã¯ JSONB å‹ã‚«ãƒ©ãƒ ã‚’å‹å®‰å…¨ã«æ‰±ã†ã“ã¨ã§ã‚ã‚‹ãŸã‚ï¼Œä¸€æ™‚çš„ã« Check åˆ¶ç´„ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã¯å–ã‚Šã¾ã›ã‚“ï¼

æœ¬è¨˜äº‹ã§ã¯ï¼Œã“ã‚Œä»¥å¤–ã®å…·ä½“çš„ãªè§£æ±ºç­–ã‚’æç¤ºã§ãã¾ã›ã‚“ãŒï¼ŒJSONB å‹ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ JSON Schema ã«ã‚ˆã‚‹æ¤œè¨¼ã‚’å°å…¥ã™ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œè¨ã™ã‚‹éš›ã®ä¸€ã¤ã®æŒ‡æ¨™ã¨ã—ã¦ï¼Œæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã«å¯¾ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã®å®Ÿè¡Œæ™‚é–“ã‚’ä½•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹è¨ˆæ¸¬ã—ã¦ã¿ã¾ã™ï¼

#### æ¤œè¨¼ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«

æ¤œè¨¼ã®ãŸã‚ï¼Œã“ã‚Œã¾ã§ã®ä¾‹ã¨ã—ã¦ä½¿ã£ãŸ Schema ã‚ˆã‚Šã‚‚ã†å°‘ã—è¤‡é›‘ãª Schema ã‚’ç”¨æ„ã—ã¾ã™ï¼

:::details create table

```sql
create table products (
    id uuid primary key default gen_random_uuid() not null,
    name text not null,
    category text not null,
    price integer not null,
    detail jsonb not null,

    constraint products_detail_chk check(
        case category
            when 'book' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "author": {
                        "type": "string",
                        "description": "è‘—è€…"
                    },
                    "publisher": {
                        "type": "string",
                        "description": "å‡ºç‰ˆç¤¾"
                    },
                    "publication_date": {
                        "type": "string",
                        "description": "å‡ºç‰ˆæ—¥",
                        "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
                    },
                    "page_count": {
                        "type": "integer",
                        "description": "ãƒšãƒ¼ã‚¸æ•°"
                    },
                    "language": {
                        "type": "string",
                        "description": "è¨€èª",
                        "enum": ["Japanese", "English", "Chinese", "Korean"]
                    },
                    "genre": {
                        "type": "string",
                        "description": "ã‚¸ãƒ£ãƒ³ãƒ«"
                    },
                    "chapters": {
                        "type": "array",
                        "description": "ç« ",
                        "items": {
                            "type": "object",
                            "properties": {
                                "title": {
                                    "type": "string",
                                    "description": "ã‚¿ã‚¤ãƒˆãƒ«"
                                },
                                "start_page": {
                                    "type": "integer",
                                    "description": "é–‹å§‹ãƒšãƒ¼ã‚¸"
                                },
                                "end_page": {
                                    "type": "integer",
                                    "description": "çµ‚äº†ãƒšãƒ¼ã‚¸"
                                }
                            },
                            "additionalProperties": false
                        },
                        "minItems": 1,
                        "additionalItems": false
                    }
                },
                "additionalProperties": false,
                "required": ["author", "publisher", "publication_date", "page_count", "language", "genre"]
            }'::json, detail)
            when 'electronics' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "brand": {
                        "type": "string",
                        "description": "ãƒ–ãƒ©ãƒ³ãƒ‰"
                    },
                    "specifications": {
                        "type": "object",
                        "description": "ä»•æ§˜",
                        "properties": {
                            "voltage": {
                                "type": "string",
                                "description": "é›»åœ§",
                                "pattern": "^[0-9]+V$"
                            },
                            "power_consumption": {
                                "type": "string",
                                "description": "æ¶ˆè²»é›»åŠ›",
                                "pattern": "^[0-9]+W$"
                            }
                        },
                        "additionalProperties": false,
                        "required": ["voltage", "power_consumption"]
                    },
                    "warranty_period": {
                        "type": "string",
                        "description": "ä¿è¨¼æœŸé–“"
                    },
                    "dimensions": {
                        "type": "object",
                        "description": "å¯¸æ³•",
                        "properties": {
                            "width": {
                                "type": "number",
                                "description": "å¹…"
                            },
                            "height": {
                                "type": "number",
                                "description": "é«˜ã•"
                            },
                            "depth": {
                                "type": "number",
                                "description": "å¥¥è¡Œã"
                            }
                        },
                        "additionalProperties": false,
                        "required": ["width", "height", "depth"]
                    },
                    "features": {
                        "type": "array",
                        "description": "æ©Ÿèƒ½",
                        "items": {
                            "type": "string",
                            "minLength": 0
                        }
                    }
                },
                "additionalProperties": false,
                "required": ["brand", "specifications", "warranty_period", "dimensions", "features"]
            }'::json, detail)
            else false
        end
    )
);
```

:::

ä»Šå›ã¯ï¼Œcategory ã« `clothes` ã‚’è¿½åŠ ã™ã‚‹ã¨ã„ã†ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚’è¡Œã„ã¾ã™ï¼

:::details modify json schema

```sql
begin;

alter table products drop constraint products_detail_chk;

alter table products add constraint products_detail_chk check(
    case category
            when 'book' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "author": {
                        "type": "string",
                        "description": "è‘—è€…"
                    },
                    "publisher": {
                        "type": "string",
                        "description": "å‡ºç‰ˆç¤¾"
                    },
                    "publication_date": {
                        "type": "string",
                        "description": "å‡ºç‰ˆæ—¥",
                        "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
                    },
                    "page_count": {
                        "type": "integer",
                        "description": "ãƒšãƒ¼ã‚¸æ•°"
                    },
                    "language": {
                        "type": "string",
                        "description": "è¨€èª",
                        "enum": ["Japanese", "English", "Chinese", "Korean"]
                    },
                    "genre": {
                        "type": "string",
                        "description": "ã‚¸ãƒ£ãƒ³ãƒ«"
                    },
                    "chapters": {
                        "type": "array",
                        "description": "ç« ",
                        "items": {
                            "type": "object",
                            "properties": {
                                "title": {
                                    "type": "string",
                                    "description": "ã‚¿ã‚¤ãƒˆãƒ«"
                                },
                                "start_page": {
                                    "type": "integer",
                                    "description": "é–‹å§‹ãƒšãƒ¼ã‚¸"
                                },
                                "end_page": {
                                    "type": "integer",
                                    "description": "çµ‚äº†ãƒšãƒ¼ã‚¸"
                                }
                            },
                            "additionalProperties": false
                        },
                        "minItems": 1,
                        "additionalItems": false
                    }
                },
                "additionalProperties": false,
                "required": ["author", "publisher", "publication_date", "page_count", "language", "genre"]
            }'::json, detail)
            when 'electronics' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "brand": {
                        "type": "string",
                        "description": "ãƒ–ãƒ©ãƒ³ãƒ‰"
                    },
                    "specifications": {
                        "type": "object",
                        "description": "ä»•æ§˜",
                        "properties": {
                            "voltage": {
                                "type": "string",
                                "description": "é›»åœ§",
                                "pattern": "^[0-9]+V$"
                            },
                            "power_consumption": {
                                "type": "string",
                                "description": "æ¶ˆè²»é›»åŠ›",
                                "pattern": "^[0-9]+W$"
                            }
                        },
                        "additionalProperties": false,
                        "required": ["voltage", "power_consumption"]
                    },
                    "warranty_period": {
                        "type": "string",
                        "description": "ä¿è¨¼æœŸé–“"
                    },
                    "dimensions": {
                        "type": "object",
                        "description": "å¯¸æ³•",
                        "properties": {
                            "width": {
                                "type": "number",
                                "description": "å¹…"
                            },
                            "height": {
                                "type": "number",
                                "description": "é«˜ã•"
                            },
                            "depth": {
                                "type": "number",
                                "description": "å¥¥è¡Œã"
                            }
                        },
                        "additionalProperties": false,
                        "required": ["width", "height", "depth"]
                    },
                    "features": {
                        "type": "array",
                        "description": "æ©Ÿèƒ½",
                        "items": {
                            "type": "string",
                            "minLength": 0
                        }
                    }
                },
                "additionalProperties": false,
                "required": ["brand", "specifications", "warranty_period", "dimensions", "features"]
            }'::json, detail)
            when 'clothes' then jsonb_matches_schema('{
                "$schema": "http://json-schema.org/draft-07/schema#",
                "type": "object",
                "properties": {
                    "brand": {
                        "type": "string",
                        "description": "ãƒ–ãƒ©ãƒ³ãƒ‰"
                    },
                    "size": {
                        "type": "object",
                        "description": "ã‚µã‚¤ã‚º",
                        "properties": {
                            "type": {
                                "type": "string",
                                "description": "ã‚¿ã‚¤ãƒ—",
                                "enum": ["XS","S", "M", "L", "XL"]
                            },
                            "measurements": {
                                "type": "object",
                                "description": "å¯¸æ³•",
                                "properties": {
                                    "chest": {
                                        "type": "number",
                                        "description": "èƒ¸å›²"
                                    },
                                    "waist": {
                                        "type": "number",
                                        "description": "ã‚¦ã‚¨ã‚¹ãƒˆ"
                                    },
                                    "hips": {
                                        "type": "number",
                                        "description": "ãƒ’ãƒƒãƒ—"
                                    }
                                },
                                "additionalProperties": false,
                                "required": ["chest", "waist", "hips"]
                            }
                        },
                        "additionalProperties": false,
                        "required": ["type", "measurements"]
                    },
                    "color": {
                        "type": "string",
                        "description": "è‰²"
                    },
                    "material": {
                        "type": "object",
                        "description": "ç´ æ",
                        "properties": {
                            "main": {
                                "type": "string",
                                "description": "ãƒ¡ã‚¤ãƒ³ç´ æ"
                            },
                            "lining": {
                                "type": "string",
                                "description": "è£åœ°"
                            }
                        },
                        "additionalProperties": false,
                        "required": ["main"]
                    },
                    "washing_instructions": {
                        "type": "array",
                        "description": "æ´—æ¿¯æ–¹æ³•",
                        "items": {
                            "type": "string"
                        }
                    }
                },
                "additionalProperties": false,
                "required": ["brand", "size", "color", "material", "washing_instructions"]
            }'::json, detail)
            else false
        end
);

commit;
```

:::

ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ PHP ã§å®Ÿè£…ã—ã¾ã™ï¼

**ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
:::details create_table.php

```php

<?php

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
$pdo = new PDO(
    'pgsql:host=localhost;dbname=testing;port=5432',
    'testing',
    'password',
);

try {
    $pdo->beginTransaction();

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã£ãŸã‚‰å‰Šé™¤ã™ã‚‹
    $sql = 'DROP TABLE IF EXISTS products;';
    $pdo->exec($sql);

    // JSON Schema ã‚’èª­ã¿è¾¼ã‚€
    $book = file_get_contents('./schemas/book.json');
    $electronics = file_get_contents('./schemas/electronics.json');
    $clothes = file_get_contents('./schemas/clothes.json');

    // æ–°ã—ã„åˆ¶ç´„ã‚’è¿½åŠ 
    $sql = "
        CREATE TABLE products (
            id uuid primary key default gen_random_uuid() not null,
            name text not null,
            category text not null,
            price integer not null,
            detail jsonb not null,

            CONSTRAINT products_detail_chk CHECK (
                CASE category
                    WHEN 'book' THEN jsonb_matches_schema('$book'::json, detail)
                    WHEN 'electronics' THEN jsonb_matches_schema('$electronics'::json, detail)
                    ELSE false
                END
            )
        );
    ";

    $pdo->exec($sql);
    $pdo->commit();
} catch (PDOException $e) {
    $pdo->rollBack();
    echo 'error: ' . $e->getMessage() . "\n";
}

echo "products ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ\n";

```

:::

**ä»»æ„ã®ä»¶æ•°ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
:::details insert_data.php

```php

<?php

// æŒ‡å®šè¦ç´ ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
function pick_values(array $input, int $count = 3): array
{
    if (count($input) < $count) {
        return $input;
    }

    $randomKeys = array_rand($input, $count);

    if (is_array($randomKeys)) {
        return array_map(fn($key) => $input[$key], $randomKeys);
    }

    return [$input[$randomKeys]];
}

function create_electronics_detail(): array
{
    return [
        'brand' => 'Brand_' . rand(1, 100),
        'specifications' => [
            'voltage' => rand(100, 240) . 'V',
            'power_consumption' => rand(100, 2000) . 'W',
        ],
        'warranty_period' => rand(1, 5) . ' years',
        'dimensions' => [
            'width' => rand(10, 100),
            'height' => rand(10, 100),
            'depth' => rand(10, 100),
        ],
        'features' => pick_values(['AAA', 'BBB', 'CCC', 'DDD', 'EEE', 'FFF', 'GGG'], 3),
    ];
}

function create_book_detail(): array
{
    return [
        'author' => 'Author_' . rand(1, 100),
        'publisher' => 'Publisher_' . rand(1, 100),
        'publication_date' => date('Y-m-d', strtotime('-' . rand(0, 365) . ' days')),
        'page_count' => rand(100, 500),
        'language' => ['Japanese', 'English', 'Chinese', 'Korean'][rand(0, 3)],
        'genre' => 'Genre_' . rand(1, 10),
        'chapters' => [
            [
                'title' => 'Chapter_1',
                'start_page' => 1,
                'end_page' => rand(20, 50)
            ]
        ]
    ];
}

// ä»¶æ•°
$count = $argv[1] ?? 100;

$pdo = new PDO(
    'pgsql:host=localhost;dbname=testing;port=5432',
    'testing',
    'password',
);

echo "$count ä»¶ã‚¤ãƒ³ã‚µãƒ¼ãƒˆä¸­...\n";
try {
    $pdo->beginTransaction();

    // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦æŒ¿å…¥
    for ($i = 0; $i < $count; $i++) { // ä»»æ„ã®è¡Œæ•°ã‚’æŒ‡å®š
        $name = 'Product_' . rand(1, 100000);
        $category = rand(0, 1) ? 'book' : 'electronics';
        $price = rand(1000, 10000);

        if ($category === 'book') {
            $detail = json_encode(create_book_detail());
        } else {
            $detail = json_encode(create_electronics_detail());
        }

        $sql = "INSERT INTO products (name, category, price, detail) VALUES (:name, :category, :price, :detail)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            ':name' => $name,
            ':category' => $category,
            ':price' => $price,
            ':detail' => $detail
        ]);
    }

    $pdo->commit();
} catch (PDOException $e) {
    echo 'Connection failed: ' . $e->getMessage() . "\n";
    $pdo->rollBack();
}
echo "ã‚¤ãƒ³ã‚µãƒ¼ãƒˆçµ‚äº†\n";

```

:::

**ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
:::details modify_schema.php

```php

<?php

// æŒ‡å®šè¦ç´ ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
function pick_values(array $input, int $count = 3): array
{
    if (count($input) < $count) {
        return $input;
    }

    $randomKeys = array_rand($input, $count);

    if (is_array($randomKeys)) {
        return array_map(fn($key) => $input[$key], $randomKeys);
    }

    return [$input[$randomKeys]];
}

function create_clothes_detail(): array
{
    return [
        'brand' => 'Brand_' . rand(1, 100),
        'size' => [
            'type' => ['XS', 'S', 'M', 'L', 'XL'][rand(0, 4)],
            'measurements' => [
                'chest' => rand(80, 120),
                'waist' => rand(60, 100),
                'hips' => rand(80, 120),
            ],
        ],
        'color' => ['Red', 'Blue', 'Green', 'Black', 'White'][rand(0, 4)],
        'material' => [
            'main' => ['Cotton', 'Polyester', 'Wool'][rand(0, 2)],
            'lining' => ['Silk', 'Nylon', 'None'][rand(0, 2)],
        ],
        'washing_instructions' => pick_values(['AAA', 'BBB', 'CCC', 'DDD', 'EEE', 'FFF', 'GGG'], 3),
    ];
}

function insert_clothes(PDO $pdo) {
    $sql = "INSERT INTO products (name, category, price, detail) VALUES ('test', 'clothes', '1000', :detail)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        ':detail' => json_encode(create_clothes_detail()),
    ]);
};

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
$pdo = new PDO(
    'pgsql:host=localhost;dbname=testing;port=5432',
    'testing',
    'password',
);

$thrownError = false;

// clothes ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹
try {
    insert_clothes($pdo);
} catch (PDOException $e) {
    // ã“ã“ã«å…¥ã‚Œã° OK
    $thrownError = true;
    $message = $e->getMessage();

    if (!str_contains($message, 'new row for relation "products" violates check constraint "products_detail_chk"')) {
        // check åˆ¶ç´„ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ãªã®ã§ã‚¹ãƒˆãƒƒãƒ—
        exit();
    }

    echo "ã¡ã‚ƒã‚“ã¨ã‚¹ã‚­ãƒ¼ãƒã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n";
} finally {
    if (!$thrownError) {
        // catch ã•ã‚Œãªã‹ã£ãŸã®ã§ã‚¹ãƒˆãƒƒãƒ—
        exit();
    }
}

// ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’ç¢ºèªã™ã‚‹
$sql = "SELECT COUNT(*) FROM products";
$stmt = $pdo->query($sql);
$count = $stmt->fetchColumn();
echo "ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: $count è¡Œ\n";

// ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´
echo "è¨ˆæ¸¬é–‹å§‹ ...\n";
$start = microtime(true);
try {
    $pdo->beginTransaction();

    // æ—¢å­˜ã®åˆ¶ç´„ã‚’å‰Šé™¤
    $pdo->exec("ALTER TABLE products DROP CONSTRAINT products_detail_chk");

    // JSON Schema ã‚’èª­ã¿è¾¼ã‚€
    $book = file_get_contents('./schemas/book.json');
    $electronics = file_get_contents('./schemas/electronics.json');
    $clothes = file_get_contents('./schemas/clothes.json');

    // æ–°ã—ã„åˆ¶ç´„ã‚’è¿½åŠ 
    $sql = "
        ALTER TABLE products ADD CONSTRAINT products_detail_chk CHECK (
            CASE category
                WHEN 'book' THEN jsonb_matches_schema('$book'::json, detail)
                WHEN 'electronics' THEN jsonb_matches_schema('$electronics'::json, detail)
                WHEN 'clothes' THEN jsonb_matches_schema('$clothes'::json, detail)
                ELSE false
            END
        );
    ";

    $pdo->exec($sql);
    $pdo->commit();
} catch (PDOException $e) {
    echo 'error: ' . $e->getMessage() . "\n";
    $pdo->rollBack();
    exit();
}
$end = microtime(true);
$time = ($end - $start) * 1000; // ãƒŸãƒªç§’ã«å¤‰æ›
echo "è¨ˆæ¸¬çµ‚äº†: {$time}(ms)\n";


echo "ã‚¹ã‚­ãƒ¼ãƒãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ\n";

// alter å¾Œã¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã•ã‚Œã‚‹

try {
    $pdo->beginTransaction();
    insert_clothes($pdo);
} catch (PDOException $e) {
    // ã“ã“ã«å…¥ã£ãŸã‚‰ãƒ€ãƒ¡
    echo 'error: ' . $e->getMessage() . "\n";
    exit();
}

echo "clothes ãŒã‚¤ãƒ³ã‚µãƒ¼ãƒˆã§ãã¾ã—ãŸ\n";
$pdo->rollBack();

```

:::

æ¯”è¼ƒã®ãŸã‚ã«ï¼ŒJSON Schema å¤‰æ›´ä»¥å¤–ã«ã‚‚å…¨ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹æ“ä½œã‚’ã„ãã¤ã‹è¡Œã„ï¼ŒåŒæ§˜ã«è¨ˆæ¸¬ã—ã¾ã—ãŸï¼

- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
    `price` ã«å¯¾ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ

    ```sql
    CREATE INDEX idx_price ON products(price);
    ```

- ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›´
    `price` ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’ `bigint` ã«å¤‰æ›´

    ```sql
    ALTER TABLE products ALTER column price TYPE bigint;
    ```

- JSONB ä»¥å¤–ã®ã‚«ãƒ©ãƒ ã«å¯¾ã™ã‚‹ Check åˆ¶ç´„ã®è¿½åŠ 
    `category` ã« `enum` åˆ¶ç´„ã‚’è¿½åŠ 

    ```sql
    ALTER TABLE products ADD CONSTRAINT products_category_chk CHECK (category IN ('book', 'electronics', 'clothes'));
    ```

å„æ¤œæŸ»é …ç›®ã‚’å®Ÿè¡Œãƒ»è¨ˆæ¸¬ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼

:::details other_operations.php

```php
<?php

function measure_time(callable $callable): void
{
    $start = microtime(true);

    $callable();

    $end = microtime(true);
    $time = ($end - $start) * 1000; // ãƒŸãƒªç§’ã«å¤‰æ›
    echo "è¨ˆæ¸¬çµ‚äº†: {$time}(ms)\n";
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
$pdo = new PDO(
    'pgsql:host=localhost;dbname=testing;port=5432',
    'testing',
    'password',
);

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
echo "ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ\n";
measure_time(function () use ($pdo) {
    $pdo->beginTransaction();
    $pdo->exec("CREATE INDEX idx_price ON products(price);");
    $pdo->rollBack();
});


// ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’å¤‰æ›´
echo "ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’å¤‰æ›´\n";
measure_time(function () use ($pdo) {
    $pdo->beginTransaction();
    $pdo->exec("ALTER TABLE products ALTER column price TYPE bigint;");
    $pdo->rollBack();
});

// JSONB ä»¥å¤–ã®ã‚«ãƒ©ãƒ ã«å¯¾ã™ã‚‹ Check åˆ¶ç´„ã®è¿½åŠ 
echo "JSONB ä»¥å¤–ã®ã‚«ãƒ©ãƒ ã«å¯¾ã™ã‚‹ Check åˆ¶ç´„ã®è¿½åŠ \n";
measure_time(function () use ($pdo) {
    $pdo->beginTransaction();
    $pdo->exec("ALTER TABLE products ADD CONSTRAINT products_category_chk CHECK (category IN ('book', 'electronics', 'clothes'));");
    $pdo->rollBack();
});

```

:::

ä»¥ä¸‹ã«ï¼Œå„æ“ä½œã«ãŠã‘ã‚‹è¨ˆæ¸¬çµæœã‚’ç¤ºã—ã¾ã™ï¼

| æ“ä½œ | 100 ãƒ¬ã‚³ãƒ¼ãƒ‰ | 1000 ãƒ¬ã‚³ãƒ¼ãƒ‰ | 10000 ãƒ¬ã‚³ãƒ¼ãƒ‰ | 100000 ãƒ¬ã‚³ãƒ¼ãƒ‰ | 1000000 ãƒ¬ã‚³ãƒ¼ãƒ‰ |
|---|---|---|---|---|---|
| JSON Schema å¤‰æ›´ | 13.31 ms | 72.26 ms | 648.33 ms | 6651.49 ms | 62683.95 ms |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ | 3.16 ms | 3.50 ms | 6.51 ms | 67.17 ms | 427.62 ms|
| ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›´ | 7.42 ms | 11.26 ms | 16.45 ms | 983.67 ms | 4111.20 ms |
| JSONB ä»¥å¤–ã®ã‚«ãƒ©ãƒ ã«å¯¾ã™ã‚‹ Check åˆ¶ç´„ã®è¿½åŠ  | 0.91 ms | 0.84 ms | 1.87 ms | 14.60 ms | 161.95 ms|

```mermaid
xychart-beta
    title "æ“ä½œã”ã¨ã®å®Ÿè¡Œæ™‚é–“"
    x-axis "ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°" ["100", "1000", "10000", "100000", "1000000"]
    y-axis "æ™‚é–“ (ms)" 0 --> 70000
    line "JSON Schema å¤‰æ›´" [13.31, 72.26, 648.33, 6651.49, 62683.95]
    line "ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ" [3.16, 3.50, 6.51, 67.17, 427.62]
    line "ã‚«ãƒ©ãƒ ã®ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›´" [7.42, 11.26, 16.45, 983.67, 4111.20]
    line "Check åˆ¶ç´„ã®è¿½åŠ " [0.91, 0.84, 1.87, 14.60, 161.95]
```

ã“ã‚Œã‚’è¦‹ã‚‹é™ã‚Šï¼ŒJSON Schema ã®å¤‰æ›´æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯ï¼Œä»–ã®æ“ä½œã«æ¯”ã¹ã¦ã‹ãªã‚Šå¤§ãã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼

# ã¾ã¨ã‚

æœ¬è¨˜äº‹ã§ã¯ï¼ŒJSONB å‹ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ JSON Schema ã«ã‚ˆã‚‹ Check åˆ¶ç´„ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ï¼ŒæŸ”è»Ÿã§å®‰å…¨ãª JSONB å‹ã‚«ãƒ©ãƒ ã®å®šç¾©æ–¹æ³•ã‚’æ¤œè¨ã—ã¾ã—ãŸï¼

ã¾ãŸï¼Œã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’è¨ˆæ¸¬ã—ï¼ŒJSON Schema å¤‰æ›´æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒä»–ã®ä¸€èˆ¬çš„ãªæ“ä½œã«æ¯”ã¹ã¦å¤§ãã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸï¼

**JSONB x JSON Schema Check ã¯ç”¨æ³•ãƒ»ç”¨é‡ã‚’å®ˆã£ã¦æ­£ã—ãä½¿ã„ã¾ã—ã‚‡ã†ï¼**
