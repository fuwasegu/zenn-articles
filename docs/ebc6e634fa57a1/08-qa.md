# Q&A: よくある疑問

## Q. Eloquent のリレーション使っちゃダメなの？

**A. 同一モジュール内なら OK、モジュール境界を超えるのは NG。**

```php
// ✅ OK: 同一モジュール内
class AssignmentModel extends Model
{
    public function histories(): HasMany
    {
        return $this->hasMany(AssignmentHistoryModel::class);
    }
}

// ❌ NG: モジュール境界を超える
class AssignmentModel extends Model
{
    public function member(): BelongsTo
    {
        return $this->belongsTo(MemberModel::class);  // Member モジュール！
    }
}
```

モジュール境界を超える場合は、Contract の `QueryService` 経由でアクセス。

---

## Q. Collection は Domain 層で使えないの？

**A. Domain 層では使わない。Application 層では許可。**

理由：
- Domain 層は「純粋な PHP」を維持したい
- Application 層は Laravel アプリケーションの一部なので、`Illuminate\Support\Collection` を使っても実用上問題ない
- メモリ効率（`LazyCollection`）や可読性のメリットが大きい

```php
// Application 層: Collection OK
$conditions = Collection::make($input->memberIds)
    ->map(fn (string $v) => MemberId::create($v))
    ->all();

// Domain 層: 純粋な PHP 配列
/** @param array<MemberId> $memberIds */
public function validateAssignments(array $memberIds): void
{
    // ...
}
```

---

## Q. ここまでやる必要ある？

**A. プロジェクトの規模と寿命による。**

| 状況 | 推奨 |
|-----|------|
| 数ヶ月で終わる小規模プロジェクト | 「なんちゃって」で十分 |
| 数年続く大規模プロジェクト | 秩序がないと破綻する |
| チームが入れ替わる可能性がある | 「なぜそうなっているか」が明文化されている価値 |

重要なのは「全部やる or 全部やらない」ではなく、**チームが合意した境界線を守ること**。

---

## Q. UseCase と Interactor を分けるのはなぜ？

**A. Interface と実装の分離。**

```php
// UseCase: Interface（契約）
interface StoreAssignmentUseCase
{
    public function handle(StoreAssignmentInput $input): AssignmentView;
}

// Interactor: 実装
final readonly class StoreAssignmentInteractor implements StoreAssignmentUseCase
{
    public function handle(StoreAssignmentInput $input): AssignmentView
    {
        // 実装
    }
}
```

メリット：
- テスト時にモックしやすい
- 実装の差し替えが可能（例: キャッシュ付きバージョン）
- 依存性逆転の原則に従う

---

## Q. Snapshot と View の使い分けは？

**A. 公開範囲の違い。**

| 概念 | 配置 | 公開範囲 |
|-----|------|---------|
| **Snapshot** | Contract 層 | 他モジュールへ公開 |
| **View** | Application 層 | モジュール内部のみ |

```php
// Snapshot: 他モジュールが参照可能
// modules/Contract/Member/Snapshots/MemberSnapshot.php

// View: モジュール内部の UseCase 出力
// modules/Member/Application/MemberView.php
```

---

## Q. Repository の Interface は Domain 層、実装は Infrastructure 層なのはなぜ？

**A. 依存性逆転の原則（DIP）。**

```
Domain → Repository(IF)
           ↑
Infrastructure → Repository(実装)
```

- Domain 層は「何を保存したいか」を定義（Interface）
- Infrastructure 層は「どう保存するか」を実装（Eloquent, Redis, API など）
- Domain 層は Infrastructure 層に依存しない → テスト可能、差し替え可能

